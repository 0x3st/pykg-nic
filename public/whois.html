<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WHOIS 查询 - PY.KG</title>
  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --danger: #dc2626;
      --danger-hover: #b91c1c;
      --success: #16a34a;
      --warning: #d97706;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    header {
      text-align: center;
      margin-bottom: 2rem;
    }

    header h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    header p {
      color: var(--text-muted);
    }

    .card {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .card h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .btn {
      display: inline-block;
      padding: 0.625rem 1.25rem;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: background-color 0.2s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
    }

    .btn-secondary {
      background: var(--border);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: #cbd5e1;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .alert {
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .alert-error {
      background: #fef2f2;
      color: var(--danger);
      border: 1px solid #fecaca;
    }

    .alert-success {
      background: #f0fdf4;
      color: var(--success);
      border: 1px solid #bbf7d0;
    }

    .alert-info {
      background: #eff6ff;
      color: var(--primary);
      border: 1px solid #bfdbfe;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.375rem;
      font-size: 0.875rem;
    }

    .form-group input {
      width: 100%;
      padding: 0.625rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.875rem;
      font-family: inherit;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .input-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .input-group input {
      flex: 1;
    }

    .user-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .user-details {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .badge {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .badge-success {
      background: #dcfce7;
      color: var(--success);
    }

    .badge-warning {
      background: #fef3c7;
      color: var(--warning);
    }

    .domain-display {
      font-family: monospace;
      font-size: 1.25rem;
      padding: 1rem;
      background: var(--bg);
      border-radius: 6px;
      margin-bottom: 1rem;
      word-break: break-all;
    }

    .info-row {
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border);
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-row strong {
      display: inline-block;
      min-width: 100px;
      color: var(--text-muted);
    }

    .ns-list {
      list-style: none;
      padding: 0;
      margin: 0.5rem 0 0 0;
    }

    .ns-list li {
      padding: 0.5rem;
      background: var(--bg);
      border-radius: 4px;
      margin-bottom: 0.5rem;
      font-family: monospace;
      font-size: 0.875rem;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden {
      display: none !important;
    }

    footer {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    footer a {
      color: var(--primary);
      text-decoration: none;
    }

    @media (max-width: 640px) {
      .user-info {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>WHOIS 查询</h1>
      <p>查询 PY.KG 子域名注册信息</p>
    </header>

    <!-- Error/Message display -->
    <div id="message-container" class="hidden"></div>

    <!-- User section -->
    <div id="user-section" class="card hidden">
      <div class="user-info">
        <div class="user-details">
          <div class="avatar" id="user-avatar">?</div>
          <div>
            <strong id="user-name">加载中...</strong>
            <br>
            <span class="badge badge-success" id="user-trust">TL?</span>
          </div>
        </div>
        <a href="/" class="btn btn-secondary">返回首页</a>
      </div>
    </div>

    <!-- Query form -->
    <div id="query-section" class="card hidden">
      <h2>域名查询</h2>
      <form id="query-form">
        <div class="form-group">
          <label for="domain-input">输入子域名标签</label>
          <div class="input-group">
            <input
              type="text"
              id="domain-input"
              placeholder="example"
              pattern="[a-z0-9-]+"
              required
              autocomplete="off"
            >
            <button type="submit" class="btn btn-primary" id="query-btn">查询</button>
          </div>
          <small style="color: var(--text-muted); margin-top: 0.25rem; display: block;">
            只允许小写字母、数字和连字符
          </small>
        </div>
      </form>
    </div>

    <!-- Query result -->
    <div id="result-section" class="hidden">
      <!-- Result will be inserted here by JavaScript -->
    </div>

    <footer>
      <p>
        <a href="/">返回首页</a>
      </p>
    </footer>
  </div>

  <script>
    // State
    let currentUser = null;

    // DOM elements
    const messageContainer = document.getElementById('message-container');
    const userSection = document.getElementById('user-section');
    const querySection = document.getElementById('query-section');
    const resultSection = document.getElementById('result-section');
    const queryForm = document.getElementById('query-form');
    const domainInput = document.getElementById('domain-input');
    const queryBtn = document.getElementById('query-btn');

    // Show message
    function showMessage(message, type = 'error') {
      const alertClass = type === 'error' ? 'alert-error' :
                        type === 'success' ? 'alert-success' : 'alert-info';
      messageContainer.innerHTML = `<div class="alert ${alertClass}">${escapeHtml(message)}</div>`;
      messageContainer.classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Clear messages
    function clearMessages() {
      messageContainer.classList.add('hidden');
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Check authentication
    async function checkAuth() {
      try {
        const response = await fetch('/api/me');
        if (!response.ok) {
          // Not logged in, redirect to home
          window.location.href = '/?error=' + encodeURIComponent('请先登录');
          return false;
        }

        const data = await response.json();
        if (!data.success) {
          window.location.href = '/?error=' + encodeURIComponent('请先登录');
          return false;
        }

        currentUser = data.data.user;

        // Display user info
        document.getElementById('user-avatar').textContent = currentUser.username[0].toUpperCase();
        document.getElementById('user-name').textContent = currentUser.username;
        document.getElementById('user-trust').textContent = `TL${currentUser.trust_level}`;

        userSection.classList.remove('hidden');
        querySection.classList.remove('hidden');

        return true;
      } catch (e) {
        window.location.href = '/?error=' + encodeURIComponent('加载失败，请重试');
        return false;
      }
    }

    // Query whois
    async function queryWhois(domain) {
      clearMessages();
      queryBtn.disabled = true;
      queryBtn.textContent = '查询中...';
      resultSection.classList.add('hidden');

      try {
        const response = await fetch(`/api/whois?domain=${encodeURIComponent(domain)}`);
        const data = await response.json();

        if (!data.success) {
          showMessage(data.error || '查询失败', 'error');
          return;
        }

        displayResult(data.data);
      } catch (e) {
        showMessage('查询失败: ' + e.message, 'error');
      } finally {
        queryBtn.disabled = false;
        queryBtn.textContent = '查询';
      }
    }

    // Display query result
    function displayResult(data) {
      const createdDate = new Date(data.created_at).toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });

      let nsHtml = '';
      if (data.nameservers && data.nameservers.length > 0) {
        nsHtml = `
          <div class="info-row">
            <strong>NS 记录:</strong>
            <ul class="ns-list">
              ${data.nameservers.map(ns => `<li>${escapeHtml(ns)}</li>`).join('')}
            </ul>
          </div>
        `;
      }

      resultSection.innerHTML = `
        <div class="card">
          <h2>查询结果</h2>
          <div class="domain-display">${escapeHtml(data.fqdn)}</div>

          <div class="info-row">
            <strong>域名标签:</strong>
            ${escapeHtml(data.label)}
          </div>

          <div class="info-row">
            <strong>状态:</strong>
            <span class="badge badge-success">${escapeHtml(data.status)}</span>
          </div>

          <div class="info-row">
            <strong>注册时间:</strong>
            ${createdDate}
          </div>

          <div class="info-row">
            <strong>所有者:</strong>
            ${escapeHtml(data.owner.username)} (LinuxDO ID: ${data.owner.linuxdo_id})
          </div>

          ${nsHtml}
        </div>
      `;

      resultSection.classList.remove('hidden');
    }

    // Form submit handler
    queryForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const domain = domainInput.value.toLowerCase().trim();

      if (!domain) {
        showMessage('请输入域名', 'error');
        return;
      }

      // Basic validation
      if (!/^[a-z0-9-]+$/.test(domain)) {
        showMessage('域名格式错误：只允许小写字母、数字和连字符', 'error');
        return;
      }

      queryWhois(domain);
    });

    // Initialize
    checkAuth();
  </script>
</body>
</html>
