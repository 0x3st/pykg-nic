<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WHOIS æŸ¥è¯¢ - PY.KG</title>
  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --danger: #dc2626;
      --danger-hover: #b91c1c;
      --success: #16a34a;
      --warning: #d97706;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    header {
      text-align: center;
      margin-bottom: 2rem;
    }

    header h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    header p {
      color: var(--text-muted);
    }

    .card {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .card h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .btn {
      display: inline-block;
      padding: 0.625rem 1.25rem;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: background-color 0.2s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
    }

    .btn-secondary {
      background: var(--border);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: #cbd5e1;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .alert {
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .alert-error {
      background: #fef2f2;
      color: var(--danger);
      border: 1px solid #fecaca;
    }

    .alert-success {
      background: #f0fdf4;
      color: var(--success);
      border: 1px solid #bbf7d0;
    }

    .alert-info {
      background: #eff6ff;
      color: var(--primary);
      border: 1px solid #bfdbfe;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.375rem;
      font-size: 0.875rem;
    }

    .form-group input {
      width: 100%;
      padding: 0.625rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.875rem;
      font-family: inherit;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .input-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .input-group input {
      flex: 1;
    }

    .user-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .user-details {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .badge {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .badge-success {
      background: #dcfce7;
      color: var(--success);
    }

    .badge-danger {
      background: #fee2e2;
      color: var(--danger);
    }

    .badge-warning {
      background: #fef3c7;
      color: var(--warning);
    }

    .domain-display {
      font-family: monospace;
      font-size: 1.25rem;
      padding: 1rem;
      background: var(--bg);
      border-radius: 6px;
      margin-bottom: 1rem;
      word-break: break-all;
    }

    .info-row {
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border);
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-row strong {
      display: inline-block;
      min-width: 100px;
      color: var(--text-muted);
    }

    .ns-list {
      list-style: none;
      padding: 0;
      margin: 0.5rem 0 0 0;
    }

    .ns-list li {
      padding: 0.5rem;
      background: var(--bg);
      border-radius: 4px;
      margin-bottom: 0.5rem;
      font-family: monospace;
      font-size: 0.875rem;
    }

    .dns-table {
      width: 100%;
      border-collapse: collapse;
      margin: 0.5rem 0;
      font-size: 0.875rem;
    }

    .dns-table thead {
      background: var(--bg);
    }

    .dns-table th {
      padding: 0.75rem 0.5rem;
      text-align: left;
      font-weight: 600;
      color: var(--text-muted);
      border-bottom: 2px solid var(--border);
    }

    .dns-table td {
      padding: 0.75rem 0.5rem;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }

    .dns-table .type-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      background: #dbeafe;
      color: #1e40af;
      border-radius: 4px;
      font-weight: 500;
      font-size: 0.75rem;
    }

    .dns-table .proxy-icon {
      font-size: 1.1rem;
    }

    .dns-table .record-name {
      font-family: monospace;
      color: var(--primary);
      font-weight: 500;
    }

    .dns-table .record-content {
      font-family: monospace;
      word-break: break-all;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden {
      display: none !important;
    }

    footer {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    footer a {
      color: var(--primary);
      text-decoration: none;
    }

    .back-link {
      display: inline-block;
      margin-bottom: 1rem;
      color: var(--primary);
      text-decoration: none;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    @media (max-width: 640px) {
      .user-info {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="back-link">&larr; è¿”å›é¦–é¡µ</a>

    <header>
      <h1>WHOIS æŸ¥è¯¢</h1>
      <p>æŸ¥è¯¢ PY.KG å­åŸŸåæ³¨å†Œä¿¡æ¯</p>
    </header>

    <!-- Error/Message display -->
    <div id="message-container" class="hidden"></div>

    <!-- User section -->
    <div id="user-section" class="card hidden">
      <div class="user-info">
        <div class="user-details">
          <div class="avatar" id="user-avatar">?</div>
          <div>
            <strong id="user-name">åŠ è½½ä¸­...</strong>
            <br>
            <span class="badge badge-success" id="user-trust">TL?</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Query form -->
    <div id="query-section" class="card hidden">
      <h2>åŸŸåæŸ¥è¯¢</h2>
      <form id="query-form">
        <div class="form-group">
          <label for="domain-input">è¾“å…¥å­åŸŸåæ ‡ç­¾</label>
          <div class="input-group">
            <input
              type="text"
              id="domain-input"
              placeholder="example"
              pattern="[a-z0-9-]+"
              required
              autocomplete="off"
            >
            <button type="submit" class="btn btn-primary" id="query-btn">æŸ¥è¯¢</button>
          </div>
          <small style="color: var(--text-muted); margin-top: 0.25rem; display: block;">
            åªå…è®¸å°å†™å­—æ¯ã€æ•°å­—å’Œè¿å­—ç¬¦
          </small>
        </div>
      </form>
    </div>

    <!-- Query result -->
    <div id="result-section" class="hidden">
      <!-- Result will be inserted here by JavaScript -->
    </div>

    <footer>
      <p>
        <a href="/">é¦–é¡µ</a> | <a href="/whois.html">WHOIS æŸ¥è¯¢</a> | <a href="/blacklist.html">å°é»‘å±‹</a> | <a href="/logs.html">æ“ä½œæ—¥å¿—</a> | <a href="/terms.html">æœåŠ¡æ¡æ¬¾</a>
      </p>
    </footer>
  </div>

  <script>
    // State
    let currentUser = null;

    // DOM elements
    const messageContainer = document.getElementById('message-container');
    const userSection = document.getElementById('user-section');
    const querySection = document.getElementById('query-section');
    const resultSection = document.getElementById('result-section');
    const queryForm = document.getElementById('query-form');
    const domainInput = document.getElementById('domain-input');
    const queryBtn = document.getElementById('query-btn');

    // Show message
    function showMessage(message, type = 'error') {
      const alertClass = type === 'error' ? 'alert-error' :
                        type === 'success' ? 'alert-success' : 'alert-info';
      messageContainer.innerHTML = `<div class="alert ${alertClass}">${escapeHtml(message)}</div>`;
      messageContainer.classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Clear messages
    function clearMessages() {
      messageContainer.classList.add('hidden');
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Check authentication
    async function checkAuth() {
      try {
        const response = await fetch('/api/me');
        if (!response.ok) {
          // Not logged in, redirect to home
          window.location.href = '/?error=' + encodeURIComponent('è¯·å…ˆç™»å½•');
          return false;
        }

        const data = await response.json();
        if (!data.success) {
          window.location.href = '/?error=' + encodeURIComponent('è¯·å…ˆç™»å½•');
          return false;
        }

        currentUser = data.data.user;

        // Display user info
        document.getElementById('user-avatar').textContent = currentUser.username[0].toUpperCase();
        document.getElementById('user-name').textContent = currentUser.username;
        document.getElementById('user-trust').textContent = `TL${currentUser.trust_level}`;

        userSection.classList.remove('hidden');
        querySection.classList.remove('hidden');

        return true;
      } catch (e) {
        window.location.href = '/?error=' + encodeURIComponent('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
        return false;
      }
    }

    // Query whois
    async function queryWhois(domain) {
      clearMessages();
      queryBtn.disabled = true;
      queryBtn.textContent = 'æŸ¥è¯¢ä¸­...';
      resultSection.classList.add('hidden');

      try {
        const response = await fetch(`/api/whois?domain=${encodeURIComponent(domain)}`);
        const data = await response.json();

        if (!data.success) {
          showMessage(data.error || 'æŸ¥è¯¢å¤±è´¥', 'error');
          return;
        }

        displayResult(data.data);
      } catch (e) {
        showMessage('æŸ¥è¯¢å¤±è´¥: ' + e.message, 'error');
      } finally {
        queryBtn.disabled = false;
        queryBtn.textContent = 'æŸ¥è¯¢';
      }
    }

    // Display query result
    function displayResult(data) {
      const createdDate = new Date(data.created_at).toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });

      // Format TTL for display
      function formatTTL(seconds) {
        if (seconds < 60) return `${seconds}ç§’`;
        if (seconds < 3600) return `${Math.floor(seconds / 60)}åˆ†é’Ÿ`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)}å°æ—¶`;
        return `${Math.floor(seconds / 86400)}å¤©`;
      }

      let dnsRecordsHtml = '';
      if (data.dns_records && data.dns_records.length > 0) {
        dnsRecordsHtml = `
          <div class="info-row">
            <strong>DNS è®°å½•:</strong>
            <table class="dns-table">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Name</th>
                  <th>Content</th>
                  <th style="text-align: center;">Proxy</th>
                  <th>TTL</th>
                </tr>
              </thead>
              <tbody>
                ${data.dns_records.map(record => {
                  const ttlText = record.proxied ? 'Auto' : formatTTL(record.ttl);
                  const proxyIcon = record.proxied ? 'ğŸŸ ' : 'âšª';
                  const proxyTitle = record.proxied ? 'Proxied' : 'DNS only';
                  const displayName = record.name === '@' ? '@' : escapeHtml(record.name);

                  return `
                    <tr>
                      <td><span class="type-badge">${escapeHtml(record.type)}</span></td>
                      <td><span class="record-name">${displayName}</span></td>
                      <td><span class="record-content">${escapeHtml(record.content)}</span></td>
                      <td style="text-align: center;"><span class="proxy-icon" title="${proxyTitle}">${proxyIcon}</span></td>
                      <td>${ttlText}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
      }

      // Check if domain is suspended or under review
      const isSuspended = data.status === 'suspended';
      const isReview = data.status === 'review';
      const statusBadgeClass = isSuspended ? 'badge-danger' : (isReview ? 'badge-warning' : 'badge-success');

      resultSection.innerHTML = `
        <div class="card">
          <h2>æŸ¥è¯¢ç»“æœ</h2>
          <div class="domain-display">${escapeHtml(data.fqdn)}</div>

          ${isSuspended && data.suspend_reason ? `
          <div class="alert alert-error" style="margin-bottom: 1rem;">
            <strong>åŸŸåå·²è¢«æš‚åœ</strong><br>
            æš‚åœåŸå› : ${escapeHtml(data.suspend_reason)}
          </div>
          ` : ''}

          ${isReview ? `
          <div class="alert alert-info" style="margin-bottom: 1rem;">
            <strong>åŸŸåå¾…å®¡æ ¸</strong><br>
            è¯¥åŸŸåæ­£åœ¨ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸ï¼Œå®¡æ ¸é€šè¿‡åå³å¯ä½¿ç”¨ã€‚
            ${data.review_reason ? `<br>å®¡æ ¸åŸå› : ${escapeHtml(data.review_reason)}` : ''}
          </div>
          ` : ''}

          <div class="info-row">
            <strong>åŸŸåæ ‡ç­¾:</strong>
            ${escapeHtml(data.label)}
          </div>

          <div class="info-row">
            <strong>çŠ¶æ€:</strong>
            <span class="badge ${statusBadgeClass}">${escapeHtml(data.status)}</span>
          </div>

          <div class="info-row">
            <strong>æ³¨å†Œæ—¶é—´:</strong>
            ${createdDate}
          </div>

          <div class="info-row">
            <strong>æ‰€æœ‰è€…:</strong>
            ${escapeHtml(data.owner.username)}
          </div>

          ${data.python_praise ? `
          <div class="info-row">
            <strong>Python èµç¾:</strong>
            ${escapeHtml(data.python_praise)}
          </div>
          ` : ''}

          ${data.usage_purpose ? `
          <div class="info-row">
            <strong>ä½¿ç”¨ç”¨é€”:</strong>
            ${escapeHtml(data.usage_purpose)}
            ${!isSuspended && !isReview ? `<button class="btn btn-danger btn-sm" style="margin-left: 1rem;" onclick="reportDomain('${escapeHtml(data.label)}')">ä¸¾æŠ¥æ»¥ç”¨</button>` : ''}
          </div>
          ` : ''}
        </div>
      `;

      resultSection.classList.remove('hidden');
    }

    // Form submit handler
    queryForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const domain = domainInput.value.toLowerCase().trim();

      if (!domain) {
        showMessage('è¯·è¾“å…¥åŸŸå', 'error');
        return;
      }

      // Basic validation
      if (!/^[a-z0-9-]+$/.test(domain)) {
        showMessage('åŸŸåæ ¼å¼é”™è¯¯ï¼šåªå…è®¸å°å†™å­—æ¯ã€æ•°å­—å’Œè¿å­—ç¬¦', 'error');
        return;
      }

      queryWhois(domain);
    });

    // Report domain abuse
    async function reportDomain(label) {
      const reason = prompt('è¯·è¯´æ˜ä¸¾æŠ¥åŸå› ï¼ˆæ»¥ç”¨ã€éæ³•å†…å®¹ç­‰ï¼‰ï¼š');
      if (!reason || !reason.trim()) {
        return;
      }

      try {
        const response = await fetch('/api/reports', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ label, reason: reason.trim() })
        });

        const data = await response.json();
        if (data.success) {
          alert('ä¸¾æŠ¥å·²æäº¤ï¼Œç®¡ç†å‘˜å°†å°½å¿«å¤„ç†ã€‚æ„Ÿè°¢æ‚¨çš„ç›‘ç£ï¼');
        } else {
          alert('ä¸¾æŠ¥å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (e) {
        alert('ä¸¾æŠ¥å¤±è´¥: ' + e.message);
      }
    }
    window.reportDomain = reportDomain;

    // Initialize
    checkAuth();
  </script>
</body>
</html>
