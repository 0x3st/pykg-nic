<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PY.KG NIC</title>
  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --danger: #dc2626;
      --danger-hover: #b91c1c;
      --success: #16a34a;
      --warning: #d97706;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    header {
      text-align: center;
      margin-bottom: 2rem;
    }

    header h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    header p {
      color: var(--text-muted);
    }

    .card {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .card h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .btn {
      display: inline-block;
      padding: 0.625rem 1.25rem;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: background-color 0.2s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: var(--danger-hover);
    }

    .btn-secondary {
      background: var(--border);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: #cbd5e1;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .alert {
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .alert-error {
      background: #fef2f2;
      color: var(--danger);
      border: 1px solid #fecaca;
    }

    .alert-success {
      background: #f0fdf4;
      color: var(--success);
      border: 1px solid #bbf7d0;
    }

    .alert-info {
      background: #eff6ff;
      color: var(--primary);
      border: 1px solid #bfdbfe;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.375rem;
      font-size: 0.875rem;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 0.625rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.875rem;
      font-family: inherit;
    }

    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .input-group {
      display: flex;
      align-items: center;
    }

    .input-group input {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
    }

    .input-group .suffix {
      padding: 0.625rem 1rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-left: none;
      border-top-right-radius: 6px;
      border-bottom-right-radius: 6px;
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    .user-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .user-details {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .badge {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .badge-success {
      background: #dcfce7;
      color: var(--success);
    }

    .badge-warning {
      background: #fef3c7;
      color: var(--warning);
    }

    .domain-display {
      font-family: monospace;
      font-size: 1.25rem;
      padding: 1rem;
      background: var(--bg);
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .ns-list {
      list-style: none;
      padding: 0;
      margin: 1rem 0;
    }

    .ns-list li {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: var(--bg);
      border-radius: 4px;
      margin-bottom: 0.5rem;
      font-family: monospace;
      font-size: 0.875rem;
    }

    .ns-list li .ns-remove {
      margin-left: auto;
      background: none;
      border: none;
      color: var(--danger);
      cursor: pointer;
      padding: 0.25rem;
    }

    .ns-input-row {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .ns-input-row input {
      flex: 1;
    }

    .btn-sm {
      padding: 0.375rem 0.75rem;
      font-size: 0.75rem;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden {
      display: none !important;
    }

    .help-text {
      font-size: 0.8125rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
    }

    footer {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    footer a {
      color: var(--primary);
      text-decoration: none;
    }

    @media (max-width: 640px) {
      .user-info {
        flex-direction: column;
        align-items: flex-start;
      }

      .ns-input-row {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>PY.KG</h1>
      <p>PY.KG 子域名注册服务</p>
    </header>

    <!-- Error display -->
    <div id="error-container" class="hidden"></div>

    <!-- Login section (shown when not logged in) -->
    <div id="login-section" class="card hidden">
      <h2>登录</h2>
      <p style="margin-bottom: 1rem; color: var(--text-muted);">
        使用 LinuxDO 账号登录以注册您的专属子域名。
        <br>
        <small>要求：信任等级 ≥ 2</small>
      </p>
      <a href="/auth/login" class="btn btn-primary">使用 LinuxDO 登录</a>
    </div>

    <!-- User section (shown when logged in) -->
    <div id="user-section" class="card hidden">
      <div class="user-info">
        <div class="user-details">
          <div class="avatar" id="user-avatar">?</div>
          <div>
            <strong id="user-name">加载中...</strong>
            <br>
            <span class="badge badge-success" id="user-trust">TL?</span>
          </div>
        </div>
        <a href="/auth/logout" class="btn btn-secondary">退出登录</a>
      </div>
    </div>

    <!-- Domain registration section -->
    <div id="register-section" class="card hidden">
      <h2>注册子域名</h2>
      <p style="margin-bottom: 1rem; color: var(--text-muted);">
        每位用户可注册一个子域名，请谨慎选择。
      </p>
      <div class="alert alert-info" style="margin-bottom: 1rem;">
        <strong>价格：</strong><span id="domain-price">--</span> 积分（LinuxDO Credit）
      </div>
      <form id="register-form">
        <div class="form-group">
          <label for="label-input">子域名</label>
          <div class="input-group">
            <input type="text" id="label-input" placeholder="your-name" pattern="[a-z0-9-]+" required>
            <span class="suffix">.PY.KG</span>
          </div>
          <small style="color: var(--text-muted); margin-top: 0.25rem; display: block;">
            只允许小写字母、数字和连字符，长度 2-63 字符
          </small>
        </div>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
          <button type="submit" class="btn btn-primary" id="register-btn">注册</button>
          <a href="/whois.html" class="btn btn-secondary">WHOIS 查询</a>
        </div>
      </form>
    </div>

    <!-- Domain registration detail form section (Python praise + usage purpose) -->
    <div id="register-detail-section" class="card hidden">
      <h2>完善注册信息</h2>
      <div class="domain-display" id="register-domain-display">加载中...</div>
      <form id="register-detail-form">
        <div class="form-group">
          <label for="python-praise-input">
            为什么喜欢 Python？ <span style="color: var(--danger);">*</span>
          </label>
          <textarea
            id="python-praise-input"
            rows="5"
            placeholder="请写一段不少于 20 字的文字，表达您对 Python 的喜爱..."
            required
            minlength="20"
            style="width: 100%; padding: 0.625rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.875rem; font-family: inherit; resize: vertical;"
          ></textarea>
          <small style="color: var(--text-muted); margin-top: 0.25rem; display: block;">
            请至少输入 20 个字符，表达您对 Python 的爱慕之情
          </small>
        </div>
        <div class="form-group">
          <label for="usage-purpose-input">
            域名用途说明 <span style="color: var(--danger);">*</span>
          </label>
          <textarea
            id="usage-purpose-input"
            rows="4"
            placeholder="请描述您打算如何使用这个域名..."
            required
            minlength="10"
            style="width: 100%; padding: 0.625rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.875rem; font-family: inherit; resize: vertical;"
          ></textarea>
          <small style="color: var(--text-muted); margin-top: 0.25rem; display: block;">
            请简要说明域名的使用用途
          </small>
        </div>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
          <button type="submit" class="btn btn-primary" id="pay-btn">支付并完成注册</button>
          <button type="button" class="btn btn-secondary" id="back-to-label-btn">返回修改域名</button>
        </div>
      </form>
    </div>

    <!-- Pending order section -->
    <div id="pending-order-section" class="card hidden">
      <h2>待支付订单</h2>
      <div class="alert alert-warning" style="margin-bottom: 1rem;">
        您有一个待支付的域名注册订单，请完成支付或取消后重新注册。
      </div>
      <div style="margin-bottom: 1rem;">
        <p><strong>域名：</strong><span id="pending-label">--</span>.PY.KG</p>
        <p><strong>金额：</strong><span id="pending-amount">--</span> 积分</p>
        <p><strong>订单号：</strong><span id="pending-order-no">--</span></p>
        <p style="color: var(--text-muted); font-size: 0.875rem;"><strong>创建时间：</strong><span id="pending-created">--</span></p>
      </div>
      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <button class="btn btn-primary" id="continue-pay-btn">继续支付</button>
        <button class="btn btn-secondary" id="refresh-status-btn">刷新状态</button>
        <button class="btn btn-secondary" id="cancel-order-btn">取消订单</button>
      </div>
    </div>

    <!-- Domain management section -->
    <div id="domain-section" class="card hidden">
      <h2>我的域名</h2>
      <div class="domain-display" id="domain-display">加载中...</div>
      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
        <span class="badge badge-success" id="domain-status">active</span>
        <span style="color: var(--text-muted); font-size: 0.875rem;" id="domain-created"></span>
      </div>
      <button class="btn btn-danger btn-sm" id="delete-domain-btn">删除域名</button>
    </div>

    <!-- DNS Records section -->
    <div id="dns-section" class="card hidden">
      <h2>DNS 记录管理</h2>
      <div class="alert alert-info" style="margin-bottom: 1rem;">
        <strong>说明：</strong>您可以选择以下两种方式之一管理您的域名：
        <ul style="margin: 0.5rem 0 0 1.5rem;">
          <li><strong>直接解析模式：</strong>添加 A/AAAA/CNAME 记录（最多4条）</li>
          <li><strong>NS 委派模式：</strong>添加 NS 记录委派给外部 DNS 服务器（最多4条）</li>
        </ul>
        <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">
          注意：两种模式不能混用。如需切换模式，请先删除所有现有记录。
        </small>
      </div>

      <div id="dns-loading" class="loading">
        <span class="spinner"></span>
        <p>加载 DNS 记录...</p>
      </div>

      <div id="dns-content" class="hidden">
        <div class="form-group">
          <label>当前 DNS 记录 <span id="dns-mode-badge"></span></label>
          <ul class="ns-list" id="dns-list">
            <li style="color: var(--text-muted);">暂无 DNS 记录</li>
          </ul>
        </div>

        <div class="form-group">
          <label>添加 DNS 记录</label>
          <div style="margin-bottom: 0.5rem;">
            <select id="dns-type-select" style="width: 100%; padding: 0.625rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.875rem;">
              <option value="A">A - IPv4 地址</option>
              <option value="AAAA">AAAA - IPv6 地址</option>
              <option value="CNAME">CNAME - 别名</option>
              <option value="NS">NS - 名称服务器</option>
            </select>
          </div>
          <div class="ns-input-row">
            <input type="text" id="dns-content-input" placeholder="1.2.3.4">
            <button type="button" class="btn btn-secondary btn-sm" id="add-dns-btn">添加</button>
          </div>
          <p class="help-text" id="dns-type-hint">
            输入 IPv4 地址，例如：1.2.3.4
          </p>
        </div>

        <div id="dns-actions" style="margin-top: 1rem;">
          <button type="button" class="btn btn-danger btn-sm" id="clear-dns-btn">清除所有 DNS 记录</button>
        </div>
      </div>
    </div>

    <footer>
      <p>
        <a href="/whois.html">WHOIS 查询</a> |
        Powered by <a href="https://pages.cloudflare.com" target="_blank">Cloudflare Pages</a>,
        <a href="https://credit.linux.do" target="_blank">LINUX DO Credit</a>,
        <a href="https://connect.linux.do" target="_blank">LINUX DO Connect</a>
      </p>
    </footer>
  </div>

  <script>
    // State
    let currentUser = null;
    let currentDomain = null;
    let currentDNSRecords = [];
    let currentDNSMode = null;
    let pendingOrder = null;
    let domainPrice = 10;
    let pendingLabel = ''; // Store the label for registration flow

    // DOM elements
    const errorContainer = document.getElementById('error-container');
    const loginSection = document.getElementById('login-section');
    const userSection = document.getElementById('user-section');
    const registerSection = document.getElementById('register-section');
    const registerDetailSection = document.getElementById('register-detail-section');
    const pendingOrderSection = document.getElementById('pending-order-section');
    const domainSection = document.getElementById('domain-section');
    const dnsSection = document.getElementById('dns-section');

    // Show error
    function showError(message) {
      errorContainer.innerHTML = `<div class="alert alert-error">${escapeHtml(message)}</div>`;
      errorContainer.classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Show success
    function showSuccess(message) {
      errorContainer.innerHTML = `<div class="alert alert-success">${escapeHtml(message)}</div>`;
      errorContainer.classList.remove('hidden');
      setTimeout(() => errorContainer.classList.add('hidden'), 5000);
    }

    // Clear messages
    function clearMessages() {
      errorContainer.classList.add('hidden');
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Check for URL error parameter
    function checkUrlError() {
      const params = new URLSearchParams(window.location.search);
      const error = params.get('error');
      if (error) {
        showError(error);
        window.history.replaceState({}, '', '/');
        return;
      }

      // 支付返回处理
      const paymentStatus = params.get('payment');
      if (paymentStatus === 'success') {
        // 支付成功，域名已创建
        errorContainer.innerHTML = `<div class="alert alert-success">支付成功！域名已创建，正在加载...</div>`;
        errorContainer.classList.remove('hidden');
        window.history.replaceState({}, '', '/');
        setTimeout(() => window.location.reload(), 1500);
        return;
      } else if (paymentStatus === 'processing') {
        // 支付正在处理中，等待 notify callback
        errorContainer.innerHTML = `<div class="alert alert-info">支付正在处理中，请稍候刷新页面查看结果...</div>`;
        errorContainer.classList.remove('hidden');
        window.history.replaceState({}, '', '/');
        // 5 秒后自动刷新检查状态
        setTimeout(() => {
          window.location.reload();
        }, 5000);
        return;
      }

      // 通用支付返回（无明确状态）
      const fromPayment = params.get('from');
      if (fromPayment === 'payment') {
        errorContainer.innerHTML = `<div class="alert alert-info">支付处理中，请稍候...</div>`;
        errorContainer.classList.remove('hidden');
        window.history.replaceState({}, '', '/');
        setTimeout(() => {
          window.location.reload();
        }, 3000);
      }
    }

    // API helper
    async function api(method, path, body = null) {
      const options = {
        method,
        headers: {},
        credentials: 'same-origin',
      };
      if (body) {
        options.headers['Content-Type'] = 'application/json';
        options.body = JSON.stringify(body);
      }
      const response = await fetch(path, options);
      const data = await response.json();
      if (!response.ok || !data.success) {
        throw new Error(data.error || 'Request failed');
      }
      return data.data;
    }

    // Load user info
    async function loadUser() {
      try {
        const data = await api('GET', '/api/me');
        currentUser = data.user;
        domainPrice = data.price || 10;

        document.getElementById('user-avatar').textContent = currentUser.username[0].toUpperCase();
        document.getElementById('user-name').textContent = currentUser.username;
        document.getElementById('user-trust').textContent = `TL${currentUser.trust_level}`;
        document.getElementById('domain-price').textContent = domainPrice;

        loginSection.classList.add('hidden');
        userSection.classList.remove('hidden');

        await loadDomain();
      } catch (e) {
        loginSection.classList.remove('hidden');
        userSection.classList.add('hidden');
        registerSection.classList.add('hidden');
        pendingOrderSection.classList.add('hidden');
        domainSection.classList.add('hidden');
        dnsSection.classList.add('hidden');
      }
    }

    // Load domain
    async function loadDomain() {
      try {
        const data = await api('GET', '/api/domains');
        if (data.domain) {
          currentDomain = data.domain;
          currentDNSRecords = data.domain.dns_records || [];
          currentDNSMode = data.domain.dns_mode;
          pendingOrder = null;

          document.getElementById('domain-display').textContent = currentDomain.fqdn;
          document.getElementById('domain-status').textContent = currentDomain.status;
          document.getElementById('domain-created').textContent =
            `创建于 ${new Date(currentDomain.created_at).toLocaleDateString('zh-CN')}`;

          registerSection.classList.add('hidden');
          pendingOrderSection.classList.add('hidden');
          domainSection.classList.remove('hidden');
          dnsSection.classList.remove('hidden');

          renderDNSList();
          document.getElementById('dns-loading').classList.add('hidden');
          document.getElementById('dns-content').classList.remove('hidden');
        } else if (data.pendingOrder) {
          // Show pending order
          pendingOrder = data.pendingOrder;
          currentDomain = null;

          document.getElementById('pending-label').textContent = pendingOrder.label;
          document.getElementById('pending-amount').textContent = pendingOrder.amount;
          document.getElementById('pending-order-no').textContent = pendingOrder.order_no;
          document.getElementById('pending-created').textContent =
            new Date(pendingOrder.created_at).toLocaleString('zh-CN');

          registerSection.classList.add('hidden');
          pendingOrderSection.classList.remove('hidden');
          domainSection.classList.add('hidden');
          dnsSection.classList.add('hidden');
        } else {
          // No domain, no pending order - show registration
          currentDomain = null;
          pendingOrder = null;
          registerSection.classList.remove('hidden');
          pendingOrderSection.classList.add('hidden');
          domainSection.classList.add('hidden');
          dnsSection.classList.add('hidden');
        }
      } catch (e) {
        showError('加载域名失败: ' + e.message);
      }
    }

    // Render DNS records list
    function renderDNSList() {
      const list = document.getElementById('dns-list');
      const modeBadge = document.getElementById('dns-mode-badge');

      // Show mode badge
      if (currentDNSMode === 'ns') {
        modeBadge.innerHTML = '<span class="badge badge-warning">NS 委派模式</span>';
      } else if (currentDNSMode === 'direct') {
        modeBadge.innerHTML = '<span class="badge badge-success">直接解析模式</span>';
      } else {
        modeBadge.innerHTML = '';
      }

      if (currentDNSRecords.length === 0) {
        list.innerHTML = '<li style="color: var(--text-muted);">暂无 DNS 记录</li>';
      } else {
        list.innerHTML = currentDNSRecords.map(record => `
          <li>
            <span class="badge" style="background: #dbeafe; color: #1e40af; font-size: 0.75rem; margin-right: 0.5rem;">${escapeHtml(record.type)}</span>
            <span>${escapeHtml(record.content)}</span>
            <button class="ns-remove" onclick="deleteDNSRecord(${record.id})" title="删除">✕</button>
          </li>
        `).join('');
      }
    }

    // Update DNS type hint based on selected type
    function updateDNSTypeHint() {
      const type = document.getElementById('dns-type-select').value;
      const input = document.getElementById('dns-content-input');
      const hint = document.getElementById('dns-type-hint');

      const hints = {
        'A': { placeholder: '1.2.3.4', text: '输入 IPv4 地址，例如：1.2.3.4' },
        'AAAA': { placeholder: '2001:db8::1', text: '输入 IPv6 地址，例如：2001:db8::1' },
        'CNAME': { placeholder: 'example.com', text: '输入目标域名，例如：example.com' },
        'NS': { placeholder: 'ns1.example.com', text: '输入 NS 服务器地址，例如：ns1.example.com。推荐免费 DNS：Cloudflare、Hurricane Electric、deSEC' },
      };

      input.placeholder = hints[type].placeholder;
      hint.textContent = hints[type].text;
    }

    // Add DNS record
    async function addDNSRecord() {
      const typeSelect = document.getElementById('dns-type-select');
      const input = document.getElementById('dns-content-input');
      const type = typeSelect.value;
      const content = input.value.trim();

      if (!content) {
        showError('请输入记录内容');
        return;
      }

      if (currentDNSRecords.length >= 4) {
        showError('最多只能添加 4 条 DNS 记录');
        return;
      }

      const btn = document.getElementById('add-dns-btn');
      btn.disabled = true;
      btn.textContent = '添加中...';
      clearMessages();

      try {
        await api('POST', '/api/dns-records', {
          type: type,
          name: '@',
          content: content,
          ttl: 3600
        });

        // Reload domain to get updated records
        await loadDomain();
        input.value = '';
        showSuccess(`${type} 记录添加成功！DNS 生效可能需要几分钟。`);
      } catch (e) {
        showError('添加失败: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = '添加';
      }
    }

    // Delete DNS record
    async function deleteDNSRecord(recordId) {
      if (!confirm('确定要删除这条 DNS 记录吗？')) {
        return;
      }

      clearMessages();

      try {
        await api('DELETE', `/api/dns-records/${recordId}`);
        await loadDomain();
        showSuccess('DNS 记录已删除');
      } catch (e) {
        showError('删除失败: ' + e.message);
      }
    }

    // Clear all DNS records
    async function clearAllDNS() {
      if (!confirm('确定要清除所有 DNS 记录吗？这将删除所有解析记录。')) {
        return;
      }

      const btn = document.getElementById('clear-dns-btn');
      btn.disabled = true;
      btn.textContent = '清除中...';
      clearMessages();

      try {
        // Delete all records one by one
        for (const record of currentDNSRecords) {
          await api('DELETE', `/api/dns-records/${record.id}`);
        }
        await loadDomain();
        showSuccess('所有 DNS 记录已清除');
      } catch (e) {
        showError('清除失败: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = '清除所有 DNS 记录';
      }
    }

    // Submit payment form (POST)
    function submitPaymentForm(submitUrl, formData) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = submitUrl;

      for (const [key, value] of Object.entries(formData)) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        form.appendChild(input);
      }

      document.body.appendChild(form);
      form.submit();
    }

    // Register domain - Step 1: Show detail form
    document.getElementById('register-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const input = document.getElementById('label-input');
      const label = input.value.toLowerCase().trim();

      // Basic validation
      if (!label || label.length < 2 || label.length > 63) {
        showError('域名长度必须在 2-63 字符之间');
        return;
      }

      if (!/^[a-z0-9]([a-z0-9-]*[a-z0-9])?$/.test(label)) {
        showError('域名只能包含小写字母、数字和连字符，且不能以连字符开头或结尾');
        return;
      }

      // Store label and show detail form
      pendingLabel = label;
      document.getElementById('register-domain-display').textContent = `${label}.PY.KG`;

      // Hide register section, show detail section
      registerSection.classList.add('hidden');
      registerDetailSection.classList.remove('hidden');
      clearMessages();
    });

    // Back to label selection
    document.getElementById('back-to-label-btn').addEventListener('click', () => {
      registerDetailSection.classList.add('hidden');
      registerSection.classList.remove('hidden');
      clearMessages();
    });

    // Register domain - Step 2: Submit with praise and purpose
    document.getElementById('register-detail-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('pay-btn');
      const pythonPraise = document.getElementById('python-praise-input').value.trim();
      const usagePurpose = document.getElementById('usage-purpose-input').value.trim();

      // Validate
      if (pythonPraise.length < 20) {
        showError('对 Python 的赞美至少需要 20 个字符');
        return;
      }

      if (usagePurpose.length < 10) {
        showError('使用用途说明至少需要 10 个字符');
        return;
      }

      btn.disabled = true;
      btn.textContent = '处理中...';
      clearMessages();

      try {
        const data = await api('POST', '/api/domains', {
          label: pendingLabel,
          python_praise: pythonPraise,
          usage_purpose: usagePurpose,
        });

        // Submit payment form (POST)
        if (data.submit_url && data.form_data) {
          submitPaymentForm(data.submit_url, data.form_data);
        } else if (data.requires_review) {
          // Manual review required
          showSuccess(data.message || '您的域名申请需要人工审核，请耐心等待。');
          registerDetailSection.classList.add('hidden');
          setTimeout(() => window.location.reload(), 2000);
        } else {
          showError('未获取到支付表单数据');
          btn.disabled = false;
          btn.textContent = '支付并完成注册';
        }
      } catch (e) {
        showError('注册失败: ' + e.message);
        btn.disabled = false;
        btn.textContent = '支付并完成注册';
      }
    });

    // Delete domain
    document.getElementById('delete-domain-btn').addEventListener('click', async () => {
      if (!confirm('确定要删除域名吗？此操作不可恢复，所有 NS 记录将被删除。')) {
        return;
      }

      const btn = document.getElementById('delete-domain-btn');
      btn.disabled = true;
      btn.textContent = '删除中...';
      clearMessages();

      try {
        await api('DELETE', '/api/domains');
        showSuccess('域名已删除');
        currentDomain = null;
        currentNS = [];
        pendingNS = [];
        domainSection.classList.add('hidden');
        nsSection.classList.add('hidden');
        registerSection.classList.remove('hidden');
      } catch (e) {
        showError('删除失败: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = '删除域名';
      }
    });

    // Event listeners for DNS records
    document.getElementById('dns-type-select').addEventListener('change', updateDNSTypeHint);
    document.getElementById('add-dns-btn').addEventListener('click', addDNSRecord);
    document.getElementById('dns-content-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addDNSRecord();
      }
    });
    document.getElementById('clear-dns-btn').addEventListener('click', clearAllDNS);

    // Initialize DNS type hint
    updateDNSTypeHint();

    // Continue payment for pending order
    document.getElementById('continue-pay-btn').addEventListener('click', async () => {
      if (!pendingOrder) return;

      const btn = document.getElementById('continue-pay-btn');
      btn.disabled = true;
      btn.textContent = '跳转中...';

      try {
        // Re-submit with the same label to get payment form
        const data = await api('POST', '/api/domains', { label: pendingOrder.label });
        if (data.submit_url && data.form_data) {
          submitPaymentForm(data.submit_url, data.form_data);
        } else {
          showError('未获取到支付表单数据');
          btn.disabled = false;
          btn.textContent = '继续支付';
        }
      } catch (e) {
        showError('获取支付表单失败: ' + e.message);
        btn.disabled = false;
        btn.textContent = '继续支付';
      }
    });

    // Refresh status button - simply reload the page
    document.getElementById('refresh-status-btn').addEventListener('click', () => {
      window.location.reload();
    });

    // Cancel pending order
    document.getElementById('cancel-order-btn').addEventListener('click', async () => {
      if (!pendingOrder) return;

      if (!confirm('确定要取消此订单吗？取消后可以重新注册其他域名。')) {
        return;
      }

      const btn = document.getElementById('cancel-order-btn');
      btn.disabled = true;
      btn.textContent = '取消中...';
      clearMessages();

      try {
        await api('DELETE', '/api/orders/' + pendingOrder.order_no);
        showSuccess('订单已取消');
        pendingOrder = null;
        pendingOrderSection.classList.add('hidden');
        registerSection.classList.remove('hidden');
      } catch (e) {
        showError('取消订单失败: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = '取消订单';
      }
    });

    // Initialize
    checkUrlError();
    loadUser();
  </script>
</body>
</html>
