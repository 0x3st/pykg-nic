<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>py.kg - 子域名注册局</title>
  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --danger: #dc2626;
      --danger-hover: #b91c1c;
      --success: #16a34a;
      --warning: #d97706;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    header {
      text-align: center;
      margin-bottom: 2rem;
    }

    header h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    header p {
      color: var(--text-muted);
    }

    .card {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .card h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .btn {
      display: inline-block;
      padding: 0.625rem 1.25rem;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: background-color 0.2s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: var(--danger-hover);
    }

    .btn-secondary {
      background: var(--border);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: #cbd5e1;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .alert {
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .alert-error {
      background: #fef2f2;
      color: var(--danger);
      border: 1px solid #fecaca;
    }

    .alert-success {
      background: #f0fdf4;
      color: var(--success);
      border: 1px solid #bbf7d0;
    }

    .alert-info {
      background: #eff6ff;
      color: var(--primary);
      border: 1px solid #bfdbfe;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.375rem;
      font-size: 0.875rem;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 0.625rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.875rem;
      font-family: inherit;
    }

    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .input-group {
      display: flex;
      align-items: center;
    }

    .input-group input {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
    }

    .input-group .suffix {
      padding: 0.625rem 1rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-left: none;
      border-top-right-radius: 6px;
      border-bottom-right-radius: 6px;
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    .user-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .user-details {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .badge {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .badge-success {
      background: #dcfce7;
      color: var(--success);
    }

    .badge-warning {
      background: #fef3c7;
      color: var(--warning);
    }

    .domain-display {
      font-family: monospace;
      font-size: 1.25rem;
      padding: 1rem;
      background: var(--bg);
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .ns-list {
      list-style: none;
      padding: 0;
      margin: 1rem 0;
    }

    .ns-list li {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: var(--bg);
      border-radius: 4px;
      margin-bottom: 0.5rem;
      font-family: monospace;
      font-size: 0.875rem;
    }

    .ns-list li .ns-remove {
      margin-left: auto;
      background: none;
      border: none;
      color: var(--danger);
      cursor: pointer;
      padding: 0.25rem;
    }

    .ns-input-row {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .ns-input-row input {
      flex: 1;
    }

    .btn-sm {
      padding: 0.375rem 0.75rem;
      font-size: 0.75rem;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden {
      display: none !important;
    }

    .help-text {
      font-size: 0.8125rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
    }

    footer {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    footer a {
      color: var(--primary);
      text-decoration: none;
    }

    @media (max-width: 640px) {
      .user-info {
        flex-direction: column;
        align-items: flex-start;
      }

      .ns-input-row {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>py.kg</h1>
      <p>LinuxDO 社区子域名注册服务</p>
    </header>

    <!-- Error display -->
    <div id="error-container" class="hidden"></div>

    <!-- Login section (shown when not logged in) -->
    <div id="login-section" class="card hidden">
      <h2>登录</h2>
      <p style="margin-bottom: 1rem; color: var(--text-muted);">
        使用 LinuxDO 账号登录以注册您的专属子域名。
        <br>
        <small>要求：信任等级 ≥ 2</small>
      </p>
      <a href="/auth/login" class="btn btn-primary">使用 LinuxDO 登录</a>
    </div>

    <!-- User section (shown when logged in) -->
    <div id="user-section" class="card hidden">
      <div class="user-info">
        <div class="user-details">
          <div class="avatar" id="user-avatar">?</div>
          <div>
            <strong id="user-name">加载中...</strong>
            <br>
            <span class="badge badge-success" id="user-trust">TL?</span>
          </div>
        </div>
        <a href="/auth/logout" class="btn btn-secondary">退出登录</a>
      </div>
    </div>

    <!-- Domain registration section -->
    <div id="register-section" class="card hidden">
      <h2>注册子域名</h2>
      <p style="margin-bottom: 1rem; color: var(--text-muted);">
        每位用户可注册一个子域名，请谨慎选择。
      </p>
      <div class="alert alert-info" style="margin-bottom: 1rem;">
        <strong>价格：</strong><span id="domain-price">--</span> 积分（LinuxDO Credit）
      </div>
      <form id="register-form">
        <div class="form-group">
          <label for="label-input">子域名</label>
          <div class="input-group">
            <input type="text" id="label-input" placeholder="your-name" pattern="[a-z0-9-]+" required>
            <span class="suffix">.py.kg</span>
          </div>
          <small style="color: var(--text-muted); margin-top: 0.25rem; display: block;">
            只允许小写字母、数字和连字符，长度 2-63 字符
          </small>
        </div>
        <button type="submit" class="btn btn-primary" id="register-btn">支付并注册</button>
      </form>
    </div>

    <!-- Pending order section -->
    <div id="pending-order-section" class="card hidden">
      <h2>待支付订单</h2>
      <div class="alert alert-warning" style="margin-bottom: 1rem;">
        您有一个待支付的域名注册订单，请完成支付或取消后重新注册。
      </div>
      <div style="margin-bottom: 1rem;">
        <p><strong>域名：</strong><span id="pending-label">--</span>.py.kg</p>
        <p><strong>金额：</strong><span id="pending-amount">--</span> 积分</p>
        <p><strong>订单号：</strong><span id="pending-order-no">--</span></p>
        <p style="color: var(--text-muted); font-size: 0.875rem;"><strong>创建时间：</strong><span id="pending-created">--</span></p>
      </div>
      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <button class="btn btn-primary" id="continue-pay-btn">继续支付</button>
        <button class="btn btn-secondary" id="cancel-order-btn">取消订单</button>
      </div>
    </div>

    <!-- Domain management section -->
    <div id="domain-section" class="card hidden">
      <h2>我的域名</h2>
      <div class="domain-display" id="domain-display">加载中...</div>
      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
        <span class="badge badge-success" id="domain-status">active</span>
        <span style="color: var(--text-muted); font-size: 0.875rem;" id="domain-created"></span>
      </div>
      <button class="btn btn-danger btn-sm" id="delete-domain-btn">删除域名</button>
    </div>

    <!-- NS Records section -->
    <div id="ns-section" class="card hidden">
      <h2>NS 记录配置</h2>
      <div class="alert alert-info" style="margin-bottom: 1rem;">
        <strong>说明：</strong>设置 NS 记录后，您的子域名将委派给指定的 DNS 服务器管理。
        您需要在自己的 DNS 服务器上配置该子域名的解析记录。
      </div>

      <div id="ns-loading" class="loading">
        <span class="spinner"></span>
        <p>加载 NS 记录...</p>
      </div>

      <div id="ns-content" class="hidden">
        <div class="form-group">
          <label>当前 NS 记录</label>
          <ul class="ns-list" id="ns-list">
            <li style="color: var(--text-muted);">暂无 NS 记录</li>
          </ul>
        </div>

        <div class="form-group">
          <label>添加 NS 服务器</label>
          <div class="ns-input-row">
            <input type="text" id="ns-input" placeholder="ns1.example.com">
            <button type="button" class="btn btn-secondary btn-sm" id="add-ns-btn">添加</button>
          </div>
          <p class="help-text">
            输入您的 DNS 服务器地址，至少需要 2 个，最多 8 个。
            <br>
            推荐使用免费 DNS 服务：<a href="https://www.cloudflare.com/dns/" target="_blank">Cloudflare</a>、
            <a href="https://dns.he.net/" target="_blank">Hurricane Electric</a>、
            <a href="https://desec.io/" target="_blank">deSEC</a>
          </p>
        </div>

        <div id="ns-pending" class="hidden" style="margin: 1rem 0; padding: 1rem; background: var(--bg); border-radius: 6px;">
          <strong>待保存的 NS 记录：</strong>
          <ul class="ns-list" id="ns-pending-list"></ul>
          <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
            <button type="button" class="btn btn-primary" id="save-ns-btn">保存 NS 记录</button>
            <button type="button" class="btn btn-secondary" id="cancel-ns-btn">取消</button>
          </div>
        </div>

        <div id="ns-actions" style="margin-top: 1rem;">
          <button type="button" class="btn btn-danger btn-sm" id="clear-ns-btn">清除所有 NS 记录</button>
        </div>
      </div>
    </div>

    <footer>
      <p>
        Powered by <a href="https://pages.cloudflare.com" target="_blank">Cloudflare Pages</a>
      </p>
      <p style="margin-top: 0.5rem;">
        <a href="https://linux.do" target="_blank">LinuxDO 社区</a>
      </p>
    </footer>
  </div>

  <script>
    // State
    let currentUser = null;
    let currentDomain = null;
    let currentNS = [];
    let pendingNS = [];
    let pendingOrder = null;
    let domainPrice = 10;

    // DOM elements
    const errorContainer = document.getElementById('error-container');
    const loginSection = document.getElementById('login-section');
    const userSection = document.getElementById('user-section');
    const registerSection = document.getElementById('register-section');
    const pendingOrderSection = document.getElementById('pending-order-section');
    const domainSection = document.getElementById('domain-section');
    const nsSection = document.getElementById('ns-section');

    // Show error
    function showError(message) {
      errorContainer.innerHTML = `<div class="alert alert-error">${escapeHtml(message)}</div>`;
      errorContainer.classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Show success
    function showSuccess(message) {
      errorContainer.innerHTML = `<div class="alert alert-success">${escapeHtml(message)}</div>`;
      errorContainer.classList.remove('hidden');
      setTimeout(() => errorContainer.classList.add('hidden'), 5000);
    }

    // Clear messages
    function clearMessages() {
      errorContainer.classList.add('hidden');
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Check for URL error parameter
    function checkUrlError() {
      const params = new URLSearchParams(window.location.search);
      const error = params.get('error');
      if (error) {
        showError(error);
        window.history.replaceState({}, '', '/');
      }
      // Check for payment return - show info message
      const tradeNo = params.get('trade_no');
      const fromPayment = params.get('from');
      if (tradeNo || fromPayment === 'payment') {
        // User returned from payment, show info message
        errorContainer.innerHTML = `<div class="alert alert-info">支付处理中，请稍候刷新页面查看结果...</div>`;
        errorContainer.classList.remove('hidden');
        window.history.replaceState({}, '', '/');
        // Auto refresh after 2 seconds
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      }
    }

    // API helper
    async function api(method, path, body = null) {
      const options = {
        method,
        headers: {},
        credentials: 'same-origin',
      };
      if (body) {
        options.headers['Content-Type'] = 'application/json';
        options.body = JSON.stringify(body);
      }
      const response = await fetch(path, options);
      const data = await response.json();
      if (!response.ok || !data.success) {
        throw new Error(data.error || 'Request failed');
      }
      return data.data;
    }

    // Load user info
    async function loadUser() {
      try {
        const data = await api('GET', '/api/me');
        currentUser = data.user;
        domainPrice = data.price || 10;

        document.getElementById('user-avatar').textContent = currentUser.username[0].toUpperCase();
        document.getElementById('user-name').textContent = currentUser.username;
        document.getElementById('user-trust').textContent = `TL${currentUser.trust_level}`;
        document.getElementById('domain-price').textContent = domainPrice;

        loginSection.classList.add('hidden');
        userSection.classList.remove('hidden');

        await loadDomain();
      } catch (e) {
        loginSection.classList.remove('hidden');
        userSection.classList.add('hidden');
        registerSection.classList.add('hidden');
        pendingOrderSection.classList.add('hidden');
        domainSection.classList.add('hidden');
        nsSection.classList.add('hidden');
      }
    }

    // Load domain
    async function loadDomain() {
      try {
        const data = await api('GET', '/api/domains');
        if (data.domain) {
          currentDomain = data.domain;
          currentNS = data.domain.nameservers || [];
          pendingOrder = null;

          document.getElementById('domain-display').textContent = currentDomain.fqdn;
          document.getElementById('domain-status').textContent = currentDomain.status;
          document.getElementById('domain-created').textContent =
            `创建于 ${new Date(currentDomain.created_at).toLocaleDateString('zh-CN')}`;

          registerSection.classList.add('hidden');
          pendingOrderSection.classList.add('hidden');
          domainSection.classList.remove('hidden');
          nsSection.classList.remove('hidden');

          renderNSList();
          document.getElementById('ns-loading').classList.add('hidden');
          document.getElementById('ns-content').classList.remove('hidden');
        } else if (data.pendingOrder) {
          // Show pending order
          pendingOrder = data.pendingOrder;
          currentDomain = null;

          document.getElementById('pending-label').textContent = pendingOrder.label;
          document.getElementById('pending-amount').textContent = pendingOrder.amount;
          document.getElementById('pending-order-no').textContent = pendingOrder.order_no;
          document.getElementById('pending-created').textContent =
            new Date(pendingOrder.created_at).toLocaleString('zh-CN');

          registerSection.classList.add('hidden');
          pendingOrderSection.classList.remove('hidden');
          domainSection.classList.add('hidden');
          nsSection.classList.add('hidden');
        } else {
          // No domain, no pending order - show registration
          currentDomain = null;
          pendingOrder = null;
          registerSection.classList.remove('hidden');
          pendingOrderSection.classList.add('hidden');
          domainSection.classList.add('hidden');
          nsSection.classList.add('hidden');
        }
      } catch (e) {
        showError('加载域名失败: ' + e.message);
      }
    }

    // Render NS list
    function renderNSList() {
      const list = document.getElementById('ns-list');
      if (currentNS.length === 0) {
        list.innerHTML = '<li style="color: var(--text-muted);">暂无 NS 记录</li>';
      } else {
        list.innerHTML = currentNS.map(ns => `
          <li>
            <span>${escapeHtml(ns)}</span>
          </li>
        `).join('');
      }
    }

    // Render pending NS list
    function renderPendingNS() {
      const container = document.getElementById('ns-pending');
      const list = document.getElementById('ns-pending-list');

      if (pendingNS.length === 0) {
        container.classList.add('hidden');
        return;
      }

      list.innerHTML = pendingNS.map((ns, i) => `
        <li>
          <span>${escapeHtml(ns)}</span>
          <button class="ns-remove" onclick="removePendingNS(${i})" title="移除">✕</button>
        </li>
      `).join('');
      container.classList.remove('hidden');
    }

    // Add NS to pending list
    function addPendingNS() {
      const input = document.getElementById('ns-input');
      const ns = input.value.trim().toLowerCase();

      if (!ns) return;

      // Basic validation
      if (!/^([a-z0-9]([a-z0-9-]*[a-z0-9])?\.)+[a-z]{2,}\.?$/.test(ns)) {
        showError('无效的 NS 服务器格式，请输入有效的域名（如 ns1.example.com）');
        return;
      }

      // Normalize
      const normalized = ns.endsWith('.') ? ns : ns + '.';

      // Check duplicates
      if (pendingNS.includes(normalized) || currentNS.includes(normalized)) {
        showError('该 NS 服务器已存在');
        return;
      }

      if (pendingNS.length >= 8) {
        showError('最多只能添加 8 个 NS 服务器');
        return;
      }

      pendingNS.push(normalized);
      input.value = '';
      renderPendingNS();
      clearMessages();
    }

    // Remove from pending list
    function removePendingNS(index) {
      pendingNS.splice(index, 1);
      renderPendingNS();
    }

    // Cancel pending changes
    function cancelPendingNS() {
      pendingNS = [];
      renderPendingNS();
    }

    // Save NS records
    async function saveNS() {
      if (pendingNS.length < 2) {
        showError('至少需要 2 个 NS 服务器');
        return;
      }

      const btn = document.getElementById('save-ns-btn');
      btn.disabled = true;
      btn.textContent = '保存中...';
      clearMessages();

      try {
        const data = await api('PUT', '/api/ns', { nameservers: pendingNS });
        currentNS = data.nameservers;
        pendingNS = [];
        renderNSList();
        renderPendingNS();
        showSuccess('NS 记录保存成功！DNS 生效可能需要几分钟到几小时。');
      } catch (e) {
        showError('保存失败: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = '保存 NS 记录';
      }
    }

    // Clear all NS records
    async function clearNS() {
      if (!confirm('确定要清除所有 NS 记录吗？这将取消域名委派。')) {
        return;
      }

      const btn = document.getElementById('clear-ns-btn');
      btn.disabled = true;
      btn.textContent = '清除中...';
      clearMessages();

      try {
        await api('DELETE', '/api/ns');
        currentNS = [];
        pendingNS = [];
        renderNSList();
        renderPendingNS();
        showSuccess('NS 记录已清除');
      } catch (e) {
        showError('清除失败: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = '清除所有 NS 记录';
      }
    }

    // Submit payment form (POST)
    function submitPaymentForm(submitUrl, formData) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = submitUrl;

      for (const [key, value] of Object.entries(formData)) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        form.appendChild(input);
      }

      document.body.appendChild(form);
      form.submit();
    }

    // Register domain
    document.getElementById('register-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('register-btn');
      const input = document.getElementById('label-input');
      const label = input.value.toLowerCase().trim();

      btn.disabled = true;
      btn.textContent = '处理中...';
      clearMessages();

      try {
        const data = await api('POST', '/api/domains', { label });
        // Submit payment form (POST)
        if (data.submit_url && data.form_data) {
          submitPaymentForm(data.submit_url, data.form_data);
        } else {
          showError('未获取到支付表单数据');
          btn.disabled = false;
          btn.textContent = '支付并注册';
        }
      } catch (e) {
        showError('注册失败: ' + e.message);
        btn.disabled = false;
        btn.textContent = '支付并注册';
      }
    });

    // Delete domain
    document.getElementById('delete-domain-btn').addEventListener('click', async () => {
      if (!confirm('确定要删除域名吗？此操作不可恢复，所有 NS 记录将被删除。')) {
        return;
      }

      const btn = document.getElementById('delete-domain-btn');
      btn.disabled = true;
      btn.textContent = '删除中...';
      clearMessages();

      try {
        await api('DELETE', '/api/domains');
        showSuccess('域名已删除');
        currentDomain = null;
        currentNS = [];
        pendingNS = [];
        domainSection.classList.add('hidden');
        nsSection.classList.add('hidden');
        registerSection.classList.remove('hidden');
      } catch (e) {
        showError('删除失败: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = '删除域名';
      }
    });

    // Event listeners
    document.getElementById('add-ns-btn').addEventListener('click', addPendingNS);
    document.getElementById('ns-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addPendingNS();
      }
    });
    document.getElementById('save-ns-btn').addEventListener('click', saveNS);
    document.getElementById('cancel-ns-btn').addEventListener('click', cancelPendingNS);
    document.getElementById('clear-ns-btn').addEventListener('click', clearNS);

    // Continue payment for pending order
    document.getElementById('continue-pay-btn').addEventListener('click', async () => {
      if (!pendingOrder) return;

      const btn = document.getElementById('continue-pay-btn');
      btn.disabled = true;
      btn.textContent = '跳转中...';

      try {
        // Re-submit with the same label to get payment form
        const data = await api('POST', '/api/domains', { label: pendingOrder.label });
        if (data.submit_url && data.form_data) {
          submitPaymentForm(data.submit_url, data.form_data);
        } else {
          showError('未获取到支付表单数据');
          btn.disabled = false;
          btn.textContent = '继续支付';
        }
      } catch (e) {
        showError('获取支付表单失败: ' + e.message);
        btn.disabled = false;
        btn.textContent = '继续支付';
      }
    });

    // Cancel pending order
    document.getElementById('cancel-order-btn').addEventListener('click', async () => {
      if (!pendingOrder) return;

      if (!confirm('确定要取消此订单吗？取消后可以重新注册其他域名。')) {
        return;
      }

      const btn = document.getElementById('cancel-order-btn');
      btn.disabled = true;
      btn.textContent = '取消中...';
      clearMessages();

      try {
        await api('DELETE', '/api/orders/' + pendingOrder.order_no);
        showSuccess('订单已取消');
        pendingOrder = null;
        pendingOrderSection.classList.add('hidden');
        registerSection.classList.remove('hidden');
      } catch (e) {
        showError('取消订单失败: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = '取消订单';
      }
    });

    // Initialize
    checkUrlError();
    loadUser();
  </script>
</body>
</html>
