<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PY.KG NIC</title>
  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --danger: #dc2626;
      --danger-hover: #b91c1c;
      --success: #16a34a;
      --warning: #d97706;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    header {
      text-align: center;
      margin-bottom: 2rem;
    }

    header h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    header p {
      color: var(--text-muted);
    }

    .card {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .card h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .btn {
      display: inline-block;
      padding: 0.625rem 1.25rem;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: background-color 0.2s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: var(--danger-hover);
    }

    .btn-secondary {
      background: var(--border);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: #cbd5e1;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .alert {
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .alert-error {
      background: #fef2f2;
      color: var(--danger);
      border: 1px solid #fecaca;
    }

    .alert-success {
      background: #f0fdf4;
      color: var(--success);
      border: 1px solid #bbf7d0;
    }

    .alert-info {
      background: #eff6ff;
      color: var(--primary);
      border: 1px solid #bfdbfe;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.375rem;
      font-size: 0.875rem;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 0.625rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.875rem;
      font-family: inherit;
    }

    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .input-group {
      display: flex;
      align-items: center;
    }

    .input-group input {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
    }

    .input-group .suffix {
      padding: 0.625rem 1rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-left: none;
      border-top-right-radius: 6px;
      border-bottom-right-radius: 6px;
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    .user-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .user-details {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .badge {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .badge-success {
      background: #dcfce7;
      color: var(--success);
    }

    .badge-warning {
      background: #fef3c7;
      color: var(--warning);
    }

    .domain-display {
      font-family: monospace;
      font-size: 1.25rem;
      padding: 1rem;
      background: var(--bg);
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .ns-list {
      list-style: none;
      padding: 0;
      margin: 1rem 0;
    }

    .ns-list li {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: var(--bg);
      border-radius: 4px;
      margin-bottom: 0.5rem;
      font-family: monospace;
      font-size: 0.875rem;
    }

    .ns-list li .ns-remove {
      margin-left: auto;
      background: none;
      border: none;
      color: var(--danger);
      cursor: pointer;
      padding: 0.25rem;
    }

    .dns-table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
      font-size: 0.875rem;
    }

    .dns-table thead {
      background: var(--bg);
    }

    .dns-table th {
      padding: 0.75rem 0.5rem;
      text-align: left;
      font-weight: 600;
      color: var(--text-muted);
      border-bottom: 2px solid var(--border);
    }

    .dns-table td {
      padding: 0.75rem 0.5rem;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }

    .dns-table tbody tr:hover {
      background: var(--bg);
    }

    .dns-table .type-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      background: #dbeafe;
      color: #1e40af;
      border-radius: 4px;
      font-weight: 500;
      font-size: 0.75rem;
    }

    .dns-table .proxy-icon {
      font-size: 1.1rem;
    }

    .dns-table .record-name {
      font-family: monospace;
      color: var(--primary);
      font-weight: 500;
    }

    .dns-table .record-content {
      font-family: monospace;
      word-break: break-all;
    }

    .dns-table .action-btn {
      background: none;
      border: none;
      color: var(--danger);
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      font-size: 1rem;
    }

    .dns-table .action-btn:hover {
      color: var(--danger-hover);
    }

    .dns-form-grid {
      display: grid;
      grid-template-columns: 100px 150px 1fr;
      gap: 0.5rem;
      align-items: start;
    }

    @media (max-width: 768px) {
      .dns-table {
        font-size: 0.75rem;
      }

      .dns-table th,
      .dns-table td {
        padding: 0.5rem 0.25rem;
      }

      .dns-form-grid {
        grid-template-columns: 1fr;
      }
    }

    .ns-input-row {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .ns-input-row input {
      flex: 1;
    }

    .btn-sm {
      padding: 0.375rem 0.75rem;
      font-size: 0.75rem;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden {
      display: none !important;
    }

    .help-text {
      font-size: 0.8125rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
    }

    footer {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    footer a {
      color: var(--primary);
      text-decoration: none;
    }

    @media (max-width: 640px) {
      .user-info {
        flex-direction: column;
        align-items: flex-start;
      }

      .ns-input-row {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>PY.KG</h1>
      <p>PY.KG å­åŸŸåæ³¨å†ŒæœåŠ¡</p>
    </header>

    <!-- Error display -->
    <div id="error-container" class="hidden"></div>

    <!-- Login section (shown when not logged in) -->
    <div id="login-section" class="card hidden">
      <h2>ç™»å½•</h2>
      <p style="margin-bottom: 1rem; color: var(--text-muted);">
        ä½¿ç”¨ LinuxDO è´¦å·ç™»å½•ä»¥æ³¨å†Œæ‚¨çš„ä¸“å±å­åŸŸåã€‚
        <br>
        <small>è¦æ±‚ï¼šä¿¡ä»»ç­‰çº§ â‰¥ 2</small>
      </p>
      <a href="/auth/login" class="btn btn-primary">ä½¿ç”¨ LinuxDO ç™»å½•</a>
    </div>

    <!-- User section (shown when logged in) -->
    <div id="user-section" class="card hidden">
      <div class="user-info">
        <div class="user-details">
          <div class="avatar" id="user-avatar">?</div>
          <div>
            <strong id="user-name">åŠ è½½ä¸­...</strong>
            <br>
            <span class="badge badge-success" id="user-trust">TL?</span>
          </div>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <button class="btn btn-secondary btn-sm" id="notifications-btn" style="position: relative;">
            é€šçŸ¥
            <span id="unread-badge" class="hidden" style="position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center;"></span>
          </button>
          <a href="/auth/logout" class="btn btn-secondary">é€€å‡ºç™»å½•</a>
        </div>
      </div>
    </div>

    <!-- Notifications panel -->
    <div id="notifications-panel" class="card hidden">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 style="margin: 0;">æ¶ˆæ¯é€šçŸ¥</h2>
        <div style="display: flex; gap: 0.5rem;">
          <button class="btn btn-secondary btn-sm" id="mark-all-read-btn">å…¨éƒ¨æ ‡è®°å·²è¯»</button>
          <button class="btn btn-secondary btn-sm" id="close-notifications-btn">å…³é—­</button>
        </div>
      </div>
      <div id="notifications-list">
        <div class="loading">åŠ è½½ä¸­...</div>
      </div>
    </div>

    <!-- Appeal submission panel (shown when domain is suspended) -->
    <div id="appeal-section" class="card hidden">
      <h2>ç”³è¯‰è§£å°</h2>
      <div class="alert alert-warning" style="margin-bottom: 1rem;">
        æ‚¨çš„åŸŸåå·²è¢«æš‚åœï¼Œå¦‚æœæ‚¨è®¤ä¸ºè¿™æ˜¯è¯¯åˆ¤ï¼Œå¯ä»¥æäº¤ç”³è¯‰ã€‚
      </div>
      <form id="appeal-form">
        <div class="form-group">
          <label for="appeal-reason">ç”³è¯‰åŸå›  <span style="color: var(--danger);">*</span></label>
          <textarea
            id="appeal-reason"
            rows="5"
            placeholder="è¯·è¯¦ç»†è¯´æ˜æ‚¨è®¤ä¸ºåŸŸåè¢«æš‚åœçš„åŸå› ä¸æˆç«‹ï¼Œæˆ–è€…æ‚¨å·²ç»æ•´æ”¹å®Œæˆ..."
            required
            minlength="10"
            style="width: 100%; padding: 0.625rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.875rem; font-family: inherit; resize: vertical;"
          ></textarea>
          <small style="color: var(--text-muted); margin-top: 0.25rem; display: block;">
            è¯·è‡³å°‘è¾“å…¥ 10 ä¸ªå­—ç¬¦
          </small>
        </div>
        <button type="submit" class="btn btn-primary">æäº¤ç”³è¯‰</button>
      </form>
    </div>

    <!-- Domain registration section -->
    <div id="register-section" class="card hidden">
      <h2>æ³¨å†Œå­åŸŸå</h2>
      <p style="margin-bottom: 1rem; color: var(--text-muted);">
        æ¯ä½ç”¨æˆ·å¯æ³¨å†Œä¸€ä¸ªå­åŸŸåï¼Œè¯·è°¨æ…é€‰æ‹©ã€‚
      </p>
      <div class="alert alert-info" style="margin-bottom: 1rem;">
        <strong>ä»·æ ¼ï¼š</strong><span id="domain-price">--</span> ç§¯åˆ†ï¼ˆLinuxDO Creditï¼‰
      </div>
      <form id="register-form">
        <div class="form-group">
          <label for="label-input">å­åŸŸå</label>
          <div class="input-group">
            <input type="text" id="label-input" placeholder="your-name" pattern="[a-z0-9-]+" required>
            <span class="suffix">.PY.KG</span>
          </div>
          <small style="color: var(--text-muted); margin-top: 0.25rem; display: block;">
            åªå…è®¸å°å†™å­—æ¯ã€æ•°å­—å’Œè¿å­—ç¬¦ï¼Œé•¿åº¦ 2-63 å­—ç¬¦
          </small>
        </div>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
          <button type="submit" class="btn btn-primary" id="register-btn">æ³¨å†Œ</button>
          <a href="/whois.html" class="btn btn-secondary">WHOIS æŸ¥è¯¢</a>
        </div>
      </form>
    </div>

    <!-- Domain registration detail form section (Python praise + usage purpose) -->
    <div id="register-detail-section" class="card hidden">
      <h2>å®Œå–„æ³¨å†Œä¿¡æ¯</h2>
      <div class="domain-display" id="register-domain-display">åŠ è½½ä¸­...</div>

      <!-- Service Terms -->
      <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg); border-left: 3px solid var(--danger); border-radius: 4px;">
        <h3 style="font-size: 1rem; margin-bottom: 0.75rem; color: var(--danger);">PY.KG æœåŠ¡æ¡æ¬¾</h3>
        <div style="font-size: 0.875rem; line-height: 1.6; color: var(--text);">
          <p style="margin-bottom: 0.5rem;"><strong>ä¸€ã€ä½¿ç”¨è§„èŒƒ</strong></p>
          <ul style="margin-left: 1.5rem; margin-bottom: 0.75rem;">
            <li>ä¸¥ç¦å°†åŸŸåç”¨äºä»»ä½•éæ³•ç½‘ç«™ã€éæ³•æœåŠ¡æˆ–è¿æ³•æ´»åŠ¨</li>
            <li>ä¸¥ç¦å‘å¸ƒã€ä¼ æ’­è¿æ³•è¿è§„å†…å®¹ï¼ˆåŒ…æ‹¬ä½†ä¸é™äºè‰²æƒ…ã€èµŒåšã€è¯ˆéª—ã€æš´åŠ›ã€ææ€–ä¸»ä¹‰ç­‰ï¼‰</li>
            <li>ä¸¥ç¦åˆ©ç”¨åŸŸåè¿›è¡Œç½‘ç»œæ”»å‡»ã€é’“é±¼ã€è¯ˆéª—ã€ä¼ æ’­ç—…æ¯’æœ¨é©¬ç­‰æ¶æ„è¡Œä¸º</li>
            <li>ä¸¥ç¦æ»¥ç”¨åŸŸåèµ„æºï¼ŒåŒ…æ‹¬æ¶æ„æŠ¢æ³¨ã€å€’å–ã€å›¤ç§¯ç­‰è¡Œä¸º</li>
            <li>ä¸¥ç¦å‘å¸ƒè™šå‡ä¿¡æ¯æˆ–ç”¨äºè¯¯å¯¼æ€§ç”¨é€”</li>
            <li>éœ€éµå®ˆä¸­åäººæ°‘å…±å’Œå›½ç›¸å…³æ³•å¾‹æ³•è§„åŠå½“åœ°æ³•å¾‹æ³•è§„</li>
          </ul>

          <p style="margin-bottom: 0.5rem;"><strong style="color: var(--danger);">äºŒã€è¿è§„å¤„ç†</strong></p>
          <ul style="margin-left: 1.5rem; margin-bottom: 0.75rem;">
            <li><strong>å‘ç°ä¸æš‚åœï¼š</strong>ä¸€ç»å‘ç°è¿è§„è¡Œä¸ºï¼Œç®¡ç†å‘˜å°†ç«‹å³æš‚åœåŸŸåçš„å…¨éƒ¨ DNS è§£ææœåŠ¡</li>
            <li><strong>ç”³è¯‰æœºåˆ¶ï¼š</strong>ç”¨æˆ·å¯åœ¨æ§åˆ¶å°æäº¤ç”³è¯‰ï¼Œç®¡ç†å‘˜å°†é‡æ–°è¯„ä¼°åä½œå‡ºæœ€ç»ˆå¤„ç†å†³å®šï¼ˆåŒ…æ‹¬æ¢å¤ã€éƒ¨åˆ†åˆ é™¤æˆ–å®Œå…¨åˆ é™¤ DNS è®°å½•ï¼‰</li>
            <li><strong>ç”³è¯‰é™åˆ¶ï¼š</strong>æ¯ä¸ªåŸŸåä»…æœ‰ä¸€æ¬¡ç”³è¯‰æœºä¼šï¼Œè¯·åŠ¡å¿…åœ¨ç”³è¯‰ä¸­å®Œæ•´ã€å¦‚å®é™ˆè¿°æƒ…å†µ</li>
            <li><strong>åŸŸååˆ é™¤ï¼š</strong>ç»è¯„ä¼°ç¡®è®¤è¿åæœåŠ¡æ¡æ¬¾çš„åŸŸåå°†è¢«ç›´æ¥åˆ é™¤ï¼Œä¸äºˆæ¢å¤</li>
            <li><strong>æ°¸ä¹…å°ç¦ï¼š</strong>ç´¯è®¡è¿è§„ä¸‰æ¬¡çš„ç”¨æˆ·å°†è¢«æ°¸ä¹…åŠ å…¥é»‘åå•ï¼Œä¸å†äº«æœ‰ç”³è¯‰æƒåˆ©</li>
          </ul>

          <p style="margin-bottom: 0.5rem;"><strong>ä¸‰ã€è´¹ç”¨ä¸é€€æ¬¾</strong></p>
          <ul style="margin-left: 1.5rem; margin-bottom: 0.75rem;">
            <li>åŸŸåæ³¨å†Œéœ€æ”¯ä»˜ç›¸åº”ç§¯åˆ†ï¼Œä¸€ç»æ”¯ä»˜å³è§†ä¸ºæœåŠ¡å¼€å§‹</li>
            <li><strong style="color: var(--danger);">ä¸ºé˜²æ­¢æ»¥ç”¨ï¼Œæ‰€æœ‰è´¹ç”¨å‡ä¸äºˆé€€è¿˜</strong>ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼šæ³¨å†ŒæˆåŠŸã€å®¡æ ¸æœªé€šè¿‡ã€è¿è§„åˆ é™¤ç­‰æƒ…å†µ</li>
            <li>è¯·åœ¨æ³¨å†Œå‰ä»”ç»†é˜…è¯»æœåŠ¡æ¡æ¬¾ï¼Œç¡®è®¤åå†è¿›è¡Œæ”¯ä»˜</li>
          </ul>

          <p style="margin-bottom: 0.5rem;"><strong>å››ã€éšç§æ”¿ç­–</strong></p>
          <ul style="margin-left: 1.5rem; margin-bottom: 0.75rem;">
            <li><strong>ä¿¡æ¯æ”¶é›†ï¼š</strong>æˆ‘ä»¬é€šè¿‡ LinuxDO OAuth è·å–æ‚¨çš„ç”¨æˆ· IDã€ç”¨æˆ·åå’Œä¿¡ä»»ç­‰çº§ï¼Œç”¨äºèº«ä»½éªŒè¯å’ŒæœåŠ¡æä¾›</li>
            <li><strong>ä¿¡æ¯ä½¿ç”¨ï¼š</strong>æ‚¨çš„ä¿¡æ¯ä»…ç”¨äºåŸŸåæ³¨å†Œã€ç®¡ç†åŠç›¸å…³æœåŠ¡ï¼Œä¸ä¼šç”¨äºå…¶ä»–å•†ä¸šç›®çš„</li>
            <li><strong>ä¿¡æ¯å…¬å¼€ï¼š</strong>æ‚¨æ³¨å†Œçš„åŸŸååŠç”¨æˆ·åå°†åœ¨ WHOIS æŸ¥è¯¢ä¸­å…¬å¼€æ˜¾ç¤ºï¼›è¿è§„è®°å½•å°†åœ¨å°é»‘å±‹ä¸­å…¬ç¤º</li>
            <li><strong>ä¿¡æ¯å­˜å‚¨ï¼š</strong>æ‚¨çš„æ•°æ®å­˜å‚¨äº Cloudflare åŸºç¡€è®¾æ–½ï¼Œæˆ‘ä»¬é‡‡å–åˆç†æªæ–½ä¿æŠ¤æ•°æ®å®‰å…¨</li>
            <li><strong>æ—¥å¿—è®°å½•ï¼š</strong>ç³»ç»Ÿä¼šè®°å½•å…³é”®æ“ä½œæ—¥å¿—ï¼ˆå¦‚åŸŸåæ³¨å†Œã€DNS å˜æ›´ç­‰ï¼‰ï¼Œç”¨äºå®‰å…¨å®¡è®¡å’Œé—®é¢˜æ’æŸ¥</li>
          </ul>

          <p style="margin-bottom: 0.5rem;"><strong>äº”ã€ç¤¾åŒºæ–‡åŒ–</strong></p>
          <p style="margin-bottom: 0;">è®©æˆ‘ä»¬è·µè¡Œ LINUX DO çš„ç¤¾åŒºæ–‡åŒ–ï¼š</p>
          <p style="margin: 0.5rem 0; font-weight: 600; font-size: 0.95rem;">çœŸè¯šã€å‹å–„ã€å›¢ç»“ã€ä¸“ä¸š</p>
          <p style="margin: 0;">å…±å»ºä½ æˆ‘å¼•ä»¥ä¸ºè£ä¹‹ç¤¾åŒºã€‚</p>

          <p style="margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid var(--border); color: var(--text-muted); font-size: 0.8rem;">
            æœ€åæ›´æ–°ï¼š2025 å¹´ 1 æœˆ 4 æ—¥
          </p>
        </div>
      </div>

      <form id="register-detail-form">
        <div class="form-group">
          <label for="python-praise-input">
            ä¸ºä»€ä¹ˆå–œæ¬¢ Pythonï¼Ÿ <span style="color: var(--danger);">*</span>
          </label>
          <textarea
            id="python-praise-input"
            rows="5"
            placeholder="è¯·å†™ä¸€æ®µä¸å°‘äº 20 å­—çš„æ–‡å­—ï¼Œè¡¨è¾¾æ‚¨å¯¹ Python çš„å–œçˆ±..."
            required
            minlength="20"
            style="width: 100%; padding: 0.625rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.875rem; font-family: inherit; resize: vertical;"
          ></textarea>
          <small style="color: var(--text-muted); margin-top: 0.25rem; display: block;">
            è¯·è‡³å°‘è¾“å…¥ 20 ä¸ªå­—ç¬¦
          </small>
        </div>
        <div class="form-group">
          <label for="usage-purpose-input">
            åŸŸåç”¨é€”è¯´æ˜ <span style="color: var(--danger);">*</span>
          </label>
          <textarea
            id="usage-purpose-input"
            rows="4"
            placeholder="è¯·æè¿°æ‚¨æ‰“ç®—å¦‚ä½•ä½¿ç”¨è¿™ä¸ªåŸŸå..."
            required
            minlength="10"
            style="width: 100%; padding: 0.625rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.875rem; font-family: inherit; resize: vertical;"
          ></textarea>
          <small style="color: var(--text-muted); margin-top: 0.25rem; display: block;">
            è¯·å¦‚å®è¯´æ˜åŸŸåç”¨é€”ã€‚å†…å®¹ä¸å®æˆ–è¿èƒŒä½¿ç”¨æ¡æ¬¾å°†ä¼šæ‹’ç»æ³¨å†Œç”³è¯·ã€‚
          </small>
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: start; cursor: pointer;">
            <input type="checkbox" id="terms-checkbox" required style="margin-top: 0.25rem; margin-right: 0.5rem; width: 18px; height: 18px; cursor: pointer;">
            <span style="font-size: 0.875rem;">
              æˆ‘å·²é˜…è¯»å¹¶åŒæ„ <strong style="color: var(--danger);">PY.KG æœåŠ¡æ¡æ¬¾</strong>ï¼Œæ‰¿è¯ºéµå®ˆä½¿ç”¨è§„èŒƒï¼Œå¦‚æœ‰è¿è§„æ„¿æ„æ‰¿æ‹…ç›¸åº”åæœã€‚
            </span>
          </label>
        </div>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
          <button type="submit" class="btn btn-primary" id="pay-btn">æ”¯ä»˜å¹¶å®Œæˆæ³¨å†Œ</button>
          <button type="button" class="btn btn-secondary" id="back-to-label-btn">è¿”å›ä¿®æ”¹åŸŸå</button>
        </div>
      </form>
    </div>

    <!-- Pending review section (shown when domain is pending review but not yet created) -->
    <div id="pending-review-section" class="card hidden">
      <h2>åŸŸåå¾…å®¡æ ¸</h2>
      <div class="alert alert-info" style="margin-bottom: 1rem;">
        <strong>æ‚¨çš„åŸŸåæ³¨å†Œç”³è¯·æ­£åœ¨ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸</strong><br>
        å®¡æ ¸é€šè¿‡ååŸŸåå°†è‡ªåŠ¨æ¿€æ´»ï¼Œå±Šæ—¶æ‚¨å¯ä»¥é…ç½® DNS è®°å½•ã€‚
      </div>
      <div style="margin-bottom: 1rem;">
        <p><strong>ç”³è¯·åŸŸåï¼š</strong><span id="pending-review-label">--</span>.PY.KG</p>
        <p><strong>å®¡æ ¸åŸå› ï¼š</strong><span id="pending-review-reason">--</span></p>
        <p style="color: var(--text-muted); font-size: 0.875rem;"><strong>æäº¤æ—¶é—´ï¼š</strong><span id="pending-review-created">--</span></p>
      </div>
      <button class="btn btn-secondary" id="refresh-review-status-btn">åˆ·æ–°çŠ¶æ€</button>
    </div>

    <!-- Pending order section -->
    <div id="pending-order-section" class="card hidden">
      <h2>å¾…æ”¯ä»˜è®¢å•</h2>
      <div class="alert alert-warning" style="margin-bottom: 1rem;">
        æ‚¨æœ‰ä¸€ä¸ªå¾…æ”¯ä»˜çš„åŸŸåæ³¨å†Œè®¢å•ï¼Œè¯·å®Œæˆæ”¯ä»˜æˆ–å–æ¶ˆåé‡æ–°æ³¨å†Œã€‚
      </div>
      <div style="margin-bottom: 1rem;">
        <p><strong>åŸŸåï¼š</strong><span id="pending-label">--</span>.PY.KG</p>
        <p><strong>é‡‘é¢ï¼š</strong><span id="pending-amount">--</span> ç§¯åˆ†</p>
        <p><strong>è®¢å•å·ï¼š</strong><span id="pending-order-no">--</span></p>
        <p style="color: var(--text-muted); font-size: 0.875rem;"><strong>åˆ›å»ºæ—¶é—´ï¼š</strong><span id="pending-created">--</span></p>
      </div>
      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <button class="btn btn-primary" id="continue-pay-btn">ç»§ç»­æ”¯ä»˜</button>
        <button class="btn btn-secondary" id="refresh-status-btn">åˆ·æ–°çŠ¶æ€</button>
        <button class="btn btn-secondary" id="cancel-order-btn">å–æ¶ˆè®¢å•</button>
      </div>
    </div>

    <!-- Domain management section -->
    <div id="domain-section" class="card hidden">
      <h2>æˆ‘çš„åŸŸå</h2>
      <div id="suspend-alert" class="hidden"></div>
      <div class="domain-display" id="domain-display">åŠ è½½ä¸­...</div>
      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
        <span class="badge badge-success" id="domain-status">active</span>
        <span style="color: var(--text-muted); font-size: 0.875rem;" id="domain-created"></span>
      </div>
      <button class="btn btn-danger btn-sm" id="delete-domain-btn">åˆ é™¤åŸŸå</button>
    </div>

    <!-- DNS Records section -->
    <div id="dns-section" class="card hidden">
      <h2>DNS è®°å½•ç®¡ç†</h2>
      <div class="alert alert-info" style="margin-bottom: 1rem;">
        <strong>è¯´æ˜ï¼š</strong>æ‚¨å¯ä»¥æ·»åŠ ä»¥ä¸‹ç±»å‹çš„ DNS è®°å½•ï¼ˆæœ€å¤š10æ¡ï¼‰ï¼š
        <ul style="margin: 0.5rem 0 0 1.5rem;">
          <li><strong>A / AAAAï¼š</strong>æŒ‡å‘ IPv4 / IPv6 åœ°å€</li>
          <li><strong>CNAMEï¼š</strong>æŒ‡å‘å¦ä¸€ä¸ªåŸŸå</li>
          <li><strong>TXTï¼š</strong>ä»…é™ Let's Encrypt è¯ä¹¦éªŒè¯ï¼ˆ_acme-challengeï¼‰</li>
        </ul>
      </div>

      <div id="dns-loading" class="loading">
        <span class="spinner"></span>
        <p>åŠ è½½ DNS è®°å½•...</p>
      </div>

      <div id="dns-content" class="hidden">
        <div class="form-group">
          <label>å½“å‰ DNS è®°å½• <span id="dns-mode-badge"></span></label>
          <div id="dns-records-container">
            <p style="color: var(--text-muted); padding: 1rem;">æš‚æ—  DNS è®°å½•</p>
          </div>
        </div>

        <div class="form-group">
          <label>æ·»åŠ  DNS è®°å½•</label>
          <div class="dns-form-grid">
            <div>
              <label style="display: block; font-size: 0.75rem; margin-bottom: 0.25rem; color: var(--text-muted);">Type</label>
              <select id="dns-type-select" style="width: 100%; padding: 0.625rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.875rem;">
                <option value="A">A</option>
                <option value="AAAA">AAAA</option>
                <option value="CNAME">CNAME</option>
                <option value="TXT">TXT</option>
              </select>
            </div>
            <div>
              <label style="display: block; font-size: 0.75rem; margin-bottom: 0.25rem; color: var(--text-muted);">Name</label>
              <input type="text" id="dns-name-input" placeholder="@" style="width: 100%; padding: 0.625rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.875rem; font-family: monospace;">
            </div>
            <div>
              <label style="display: block; font-size: 0.75rem; margin-bottom: 0.25rem; color: var(--text-muted);">Content</label>
              <input type="text" id="dns-content-input" placeholder="1.2.3.4" style="width: 100%; padding: 0.625rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.875rem; font-family: monospace;">
            </div>
          </div>
          <p class="help-text" id="dns-type-hint" style="margin-top: 0.5rem;">
            @ è¡¨ç¤ºæ ¹åŸŸåï¼Œæˆ–è¾“å…¥å­åŸŸåï¼ˆå¦‚ blogã€apiï¼‰æ¥åˆ›å»º blog.your-domain.py.kg
          </p>

          <div style="margin-top: 1rem; padding: 1rem; background: var(--bg); border-radius: 6px;">
            <div id="dns-proxy-option" style="margin-bottom: 0.75rem;">
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" id="dns-proxy-checkbox" style="margin-right: 0.5rem; width: 18px; height: 18px; cursor: pointer;">
                <span>
                  <strong>Proxy ğŸŸ </strong>
                  <small style="display: block; color: var(--text-muted); margin-top: 0.25rem;">
                    å¯ç”¨ Cloudflare CDN/DDoS é˜²æŠ¤ï¼ˆä»… A/AAAA/CNAMEï¼‰
                  </small>
                </span>
              </label>
            </div>

            <div style="margin-top: 0.75rem;">
              <label style="display: block; margin-bottom: 0.5rem;">
                TTL
                <span id="dns-ttl-auto-badge" class="hidden" style="margin-left: 0.5rem;">
                  <span class="badge" style="background: var(--warning); color: white; font-size: 0.7rem;">Auto</span>
                </span>
              </label>
              <select id="dns-ttl-select" style="width: 100%; padding: 0.625rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.875rem;">
                <option value="60">1 åˆ†é’Ÿ</option>
                <option value="300">5 åˆ†é’Ÿ</option>
                <option value="900">15 åˆ†é’Ÿ</option>
                <option value="1800">30 åˆ†é’Ÿ</option>
                <option value="3600" selected>1 å°æ—¶</option>
                <option value="7200">2 å°æ—¶</option>
                <option value="14400">4 å°æ—¶</option>
                <option value="43200">12 å°æ—¶</option>
                <option value="86400">1 å¤©</option>
              </select>
              <small style="color: var(--text-muted); margin-top: 0.25rem; display: block;">
                <span id="dns-ttl-hint">DNS ç¼“å­˜æ—¶é—´</span>
              </small>
            </div>
          </div>

          <button type="button" class="btn btn-primary" id="add-dns-btn" style="margin-top: 1rem; width: 100%;">æ·»åŠ è®°å½•</button>
        </div>

        <div id="dns-actions" style="margin-top: 1rem;">
          <button type="button" class="btn btn-danger btn-sm" id="clear-dns-btn">æ¸…é™¤æ‰€æœ‰ DNS è®°å½•</button>
        </div>
      </div>
    </div>

    <footer>
      <p>
        <a href="/whois.html">WHOIS æŸ¥è¯¢</a> | <a href="/blacklist.html">å°é»‘å±‹</a> | <a href="/logs.html">æ“ä½œæ—¥å¿—</a>
      </p>
    </footer>
  </div>

  <script>
    // State
    let currentUser = null;
    let currentDomain = null;
    let currentDNSRecords = [];
    let currentDNSMode = null;
    let pendingOrder = null;
    let domainPrice = 10;
    let pendingLabel = ''; // Store the label for registration flow
    let unreadNotifications = [];

    // DOM elements
    const errorContainer = document.getElementById('error-container');
    const loginSection = document.getElementById('login-section');
    const userSection = document.getElementById('user-section');
    const registerSection = document.getElementById('register-section');
    const registerDetailSection = document.getElementById('register-detail-section');
    const pendingReviewSection = document.getElementById('pending-review-section');
    const pendingOrderSection = document.getElementById('pending-order-section');
    const domainSection = document.getElementById('domain-section');
    const dnsSection = document.getElementById('dns-section');

    // Show error
    function showError(message) {
      errorContainer.innerHTML = `<div class="alert alert-error">${escapeHtml(message)}</div>`;
      errorContainer.classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Show success
    function showSuccess(message) {
      errorContainer.innerHTML = `<div class="alert alert-success">${escapeHtml(message)}</div>`;
      errorContainer.classList.remove('hidden');
      setTimeout(() => errorContainer.classList.add('hidden'), 5000);
    }

    // Clear messages
    function clearMessages() {
      errorContainer.classList.add('hidden');
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Check for URL error parameter
    function checkUrlError() {
      const params = new URLSearchParams(window.location.search);
      const error = params.get('error');
      if (error) {
        showError(error);
        window.history.replaceState({}, '', '/');
        return;
      }

      // æ”¯ä»˜è¿”å›å¤„ç†
      const paymentStatus = params.get('payment');
      if (paymentStatus === 'success') {
        // æ”¯ä»˜æˆåŠŸï¼ŒåŸŸåå·²åˆ›å»º
        errorContainer.innerHTML = `<div class="alert alert-success">æ”¯ä»˜æˆåŠŸï¼åŸŸåå·²åˆ›å»ºï¼Œæ­£åœ¨åŠ è½½...</div>`;
        errorContainer.classList.remove('hidden');
        window.history.replaceState({}, '', '/');

        // è½®è¯¢æ£€æŸ¥åŸŸåæ˜¯å¦å·²åˆ›å»ºï¼ˆæœ€å¤šå°è¯•10æ¬¡ï¼Œæ¯æ¬¡é—´éš”2ç§’ï¼‰
        let attempts = 0;
        const maxAttempts = 10;
        const checkInterval = setInterval(async () => {
          attempts++;
          try {
            const data = await api('GET', '/api/domains');
            if (data.domain) {
              // åŸŸåå·²åˆ›å»ºï¼Œåˆ·æ–°é¡µé¢
              clearInterval(checkInterval);
              window.location.reload();
            } else if (attempts >= maxAttempts) {
              // è¶…æ—¶ï¼Œä»ç„¶åˆ·æ–°é¡µé¢
              clearInterval(checkInterval);
              window.location.reload();
            }
          } catch (e) {
            if (attempts >= maxAttempts) {
              clearInterval(checkInterval);
              window.location.reload();
            }
          }
        }, 2000);
        return;
      } else if (paymentStatus === 'processing') {
        // æ”¯ä»˜æ­£åœ¨å¤„ç†ä¸­ï¼Œç­‰å¾… notify callback
        errorContainer.innerHTML = `<div class="alert alert-info">æ”¯ä»˜æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ...</div>`;
        errorContainer.classList.remove('hidden');
        window.history.replaceState({}, '', '/');

        // è½®è¯¢æ£€æŸ¥æ”¯ä»˜çŠ¶æ€ï¼ˆæœ€å¤šå°è¯•10æ¬¡ï¼Œæ¯æ¬¡é—´éš”3ç§’ï¼‰
        let attempts = 0;
        const maxAttempts = 10;
        const checkInterval = setInterval(async () => {
          attempts++;
          try {
            const data = await api('GET', '/api/domains');
            if (data.domain) {
              // åŸŸåå·²åˆ›å»ºï¼Œæ”¯ä»˜å·²å®Œæˆ
              clearInterval(checkInterval);
              errorContainer.innerHTML = `<div class="alert alert-success">æ”¯ä»˜æˆåŠŸï¼åŸŸåå·²åˆ›å»º</div>`;
              setTimeout(() => window.location.reload(), 1000);
            } else if (attempts >= maxAttempts) {
              // è¶…æ—¶ï¼Œæç¤ºç”¨æˆ·æ‰‹åŠ¨åˆ·æ–°
              clearInterval(checkInterval);
              errorContainer.innerHTML = `<div class="alert alert-warning">æ”¯ä»˜å¤„ç†ä¸­ï¼Œè¯·ç¨åæ‰‹åŠ¨åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ</div>`;
            }
          } catch (e) {
            if (attempts >= maxAttempts) {
              clearInterval(checkInterval);
              errorContainer.innerHTML = `<div class="alert alert-warning">æ”¯ä»˜å¤„ç†ä¸­ï¼Œè¯·ç¨åæ‰‹åŠ¨åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ</div>`;
            }
          }
        }, 3000);
        return;
      }

      // é€šç”¨æ”¯ä»˜è¿”å›ï¼ˆæ— æ˜ç¡®çŠ¶æ€ï¼‰
      const fromPayment = params.get('from');
      if (fromPayment === 'payment') {
        errorContainer.innerHTML = `<div class="alert alert-info">æ”¯ä»˜å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</div>`;
        errorContainer.classList.remove('hidden');
        window.history.replaceState({}, '', '/');
        setTimeout(() => {
          window.location.reload();
        }, 3000);
      }
    }

    // API helper
    async function api(method, path, body = null) {
      const options = {
        method,
        headers: {},
        credentials: 'same-origin',
      };
      if (body) {
        options.headers['Content-Type'] = 'application/json';
        options.body = JSON.stringify(body);
      }
      const response = await fetch(path, options);
      const data = await response.json();
      if (!response.ok || !data.success) {
        throw new Error(data.error || 'Request failed');
      }
      return data.data;
    }

    // Load user info
    async function loadUser() {
      try {
        const data = await api('GET', '/api/me');
        currentUser = data.user;
        domainPrice = data.price || 10;

        document.getElementById('user-avatar').textContent = currentUser.username[0].toUpperCase();
        document.getElementById('user-name').textContent = currentUser.username;
        document.getElementById('user-trust').textContent = `TL${currentUser.trust_level}`;
        document.getElementById('domain-price').textContent = domainPrice;

        loginSection.classList.add('hidden');
        userSection.classList.remove('hidden');

        await loadDomain();
        await loadNotifications(); // Load notifications after user is loaded
      } catch (e) {
        loginSection.classList.remove('hidden');
        userSection.classList.add('hidden');
        registerSection.classList.add('hidden');
        pendingOrderSection.classList.add('hidden');
        domainSection.classList.add('hidden');
        dnsSection.classList.add('hidden');
      }
    }

    // Load domain
    async function loadDomain() {
      try {
        const data = await api('GET', '/api/domains');
        if (data.domain) {
          currentDomain = data.domain;
          currentDNSRecords = data.domain.dns_records || [];
          currentDNSMode = data.domain.dns_mode;
          pendingOrder = null;

          document.getElementById('domain-display').textContent = currentDomain.fqdn;

          // Handle suspended domains
          const statusBadge = document.getElementById('domain-status');
          const suspendAlert = document.getElementById('suspend-alert');

          if (currentDomain.status === 'suspended') {
            statusBadge.className = 'badge badge-danger';
            statusBadge.textContent = 'suspended';

            // Show suspend alert
            suspendAlert.innerHTML = `
              <div class="alert alert-error" style="margin-bottom: 1rem;">
                <strong>åŸŸåå·²è¢«æš‚åœ</strong><br>
                æš‚åœåŸå› : ${escapeHtml(currentDomain.suspend_reason || 'è¿è§„æ“ä½œ')}
              </div>
            `;
            suspendAlert.classList.remove('hidden');

            // Check if there's a pending appeal and show appropriate section
            await loadAppealStatus();

            // Hide DNS section for suspended domains
            dnsSection.classList.add('hidden');
          } else if (currentDomain.status === 'review') {
            statusBadge.className = 'badge badge-warning';
            statusBadge.textContent = 'pending review';

            // Show review alert
            suspendAlert.innerHTML = `
              <div class="alert alert-info" style="margin-bottom: 1rem;">
                <strong>åŸŸåå¾…å®¡æ ¸</strong><br>
                æ‚¨çš„åŸŸåæ³¨å†Œç”³è¯·æ­£åœ¨ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸ï¼Œå®¡æ ¸é€šè¿‡åå³å¯ä½¿ç”¨ã€‚
                ${currentDomain.review_reason ? `<br>å®¡æ ¸åŸå› : ${escapeHtml(currentDomain.review_reason)}` : ''}
              </div>
            `;
            suspendAlert.classList.remove('hidden');

            // Hide DNS section for domains pending review
            dnsSection.classList.add('hidden');
          } else {
            statusBadge.className = 'badge badge-success';
            statusBadge.textContent = currentDomain.status;
            suspendAlert.classList.add('hidden');

            // Show DNS section for active domains
            dnsSection.classList.remove('hidden');
            renderDNSList();
            document.getElementById('dns-loading').classList.add('hidden');
            document.getElementById('dns-content').classList.remove('hidden');
          }

          document.getElementById('domain-created').textContent =
            `åˆ›å»ºäº ${new Date(currentDomain.created_at).toLocaleDateString('zh-CN')}`;

          // Control delete button based on status
          const deleteBtn = document.getElementById('delete-domain-btn');
          if (currentDomain.status === 'suspended' || currentDomain.status === 'review') {
            deleteBtn.disabled = true;
            deleteBtn.title = currentDomain.status === 'suspended' ? 'æš‚åœçš„åŸŸåæ— æ³•åˆ é™¤' : 'å®¡æ ¸ä¸­çš„åŸŸåæ— æ³•åˆ é™¤';
          } else {
            deleteBtn.disabled = false;
            deleteBtn.title = '';
          }

          registerSection.classList.add('hidden');
          pendingOrderSection.classList.add('hidden');
          domainSection.classList.remove('hidden');
        } else if (data.pendingReview) {
          // Show pending review status
          currentDomain = null;
          pendingOrder = null;

          document.getElementById('pending-review-label').textContent = data.pendingReview.label;
          document.getElementById('pending-review-reason').textContent = data.pendingReview.reason || 'éœ€è¦äººå·¥å®¡æ ¸';
          document.getElementById('pending-review-created').textContent =
            new Date(data.pendingReview.created_at).toLocaleString('zh-CN');

          registerSection.classList.add('hidden');
          pendingReviewSection.classList.remove('hidden');
          pendingOrderSection.classList.add('hidden');
          domainSection.classList.add('hidden');
          dnsSection.classList.add('hidden');
        } else if (data.pendingOrder) {
          // Show pending order
          pendingOrder = data.pendingOrder;
          currentDomain = null;

          document.getElementById('pending-label').textContent = pendingOrder.label;
          document.getElementById('pending-amount').textContent = pendingOrder.amount;
          document.getElementById('pending-order-no').textContent = pendingOrder.order_no;
          document.getElementById('pending-created').textContent =
            new Date(pendingOrder.created_at).toLocaleString('zh-CN');

          registerSection.classList.add('hidden');
          pendingOrderSection.classList.remove('hidden');
          domainSection.classList.add('hidden');
          dnsSection.classList.add('hidden');
        } else {
          // No domain, no pending order, no pending review - show registration
          currentDomain = null;
          pendingOrder = null;
          registerSection.classList.remove('hidden');
          pendingReviewSection.classList.add('hidden');
          pendingOrderSection.classList.add('hidden');
          domainSection.classList.add('hidden');
          dnsSection.classList.add('hidden');
        }
      } catch (e) {
        showError('åŠ è½½åŸŸåå¤±è´¥: ' + e.message);
      }
    }

    // Render DNS records list
    function renderDNSList() {
      const container = document.getElementById('dns-records-container');
      const modeBadge = document.getElementById('dns-mode-badge');

      // Show mode badge
      if (currentDNSMode === 'ns') {
        modeBadge.innerHTML = '<span class="badge badge-warning">NS å§”æ´¾æ¨¡å¼</span>';
      } else if (currentDNSMode === 'direct') {
        modeBadge.innerHTML = '<span class="badge badge-success">ç›´æ¥è§£ææ¨¡å¼</span>';
      } else {
        modeBadge.innerHTML = '';
      }

      if (currentDNSRecords.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); padding: 1rem;">æš‚æ—  DNS è®°å½•</p>';
      } else {
        container.innerHTML = `
          <table class="dns-table">
            <thead>
              <tr>
                <th>Type</th>
                <th>Name</th>
                <th>Content</th>
                <th style="text-align: center;">Proxy</th>
                <th>TTL</th>
                <th style="width: 60px;"></th>
              </tr>
            </thead>
            <tbody>
              ${currentDNSRecords.map(record => {
                const ttlText = record.proxied ? 'Auto' : formatTTL(record.ttl);
                const proxyIcon = record.proxied ? 'ğŸŸ ' : 'âšª';
                const proxyTitle = record.proxied ? 'Proxied' : 'DNS only';
                const displayName = record.name === '@' ? '@' : escapeHtml(record.name);

                return `
                  <tr>
                    <td><span class="type-badge">${escapeHtml(record.type)}</span></td>
                    <td><span class="record-name">${displayName}</span></td>
                    <td><span class="record-content">${escapeHtml(record.content)}</span></td>
                    <td style="text-align: center;"><span class="proxy-icon" title="${proxyTitle}">${proxyIcon}</span></td>
                    <td>${ttlText}</td>
                    <td><button class="action-btn" onclick="deleteDNSRecord(${record.id})" title="åˆ é™¤">âœ•</button></td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;
      }
    }

    // Format TTL for display
    function formatTTL(seconds) {
      if (seconds < 60) return `${seconds}ç§’`;
      if (seconds < 3600) return `${Math.floor(seconds / 60)}åˆ†é’Ÿ`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)}å°æ—¶`;
      return `${Math.floor(seconds / 86400)}å¤©`;
    }

    // Update DNS type hint based on selected type
    function updateDNSTypeHint() {
      const type = document.getElementById('dns-type-select').value;
      const contentInput = document.getElementById('dns-content-input');
      const hint = document.getElementById('dns-type-hint');
      const proxyOption = document.getElementById('dns-proxy-option');
      const proxyCheckbox = document.getElementById('dns-proxy-checkbox');

      const hints = {
        'A': { placeholder: '1.2.3.4', text: '@ è¡¨ç¤ºæ ¹åŸŸåï¼Œæˆ–è¾“å…¥å­åŸŸåï¼ˆå¦‚ blogã€apiï¼‰æ¥åˆ›å»º blog.your-domain.py.kg' },
        'AAAA': { placeholder: '2001:db8::1', text: '@ è¡¨ç¤ºæ ¹åŸŸåï¼Œæˆ–è¾“å…¥å­åŸŸåæ¥åˆ›å»ºå­åŸŸåè®°å½•' },
        'CNAME': { placeholder: 'example.com', text: '@ è¡¨ç¤ºæ ¹åŸŸåï¼Œæˆ–è¾“å…¥å­åŸŸåã€‚ç›®æ ‡åŸŸåç¤ºä¾‹ï¼šexample.com' },
        'TXT': { placeholder: 'your-acme-challenge-token', text: 'ä»…é™ Let\'s Encrypt éªŒè¯ã€‚Name å¿…é¡»æ˜¯ _acme-challenge æˆ– _acme-challenge.subdomain' },
      };

      contentInput.placeholder = hints[type].placeholder;
      hint.textContent = hints[type].text;

      // Show/hide proxy option (only for A, AAAA, CNAME)
      if (type === 'TXT') {
        proxyOption.style.display = 'none';
        proxyCheckbox.checked = false;
        updateTTLState(); // Update TTL state when proxy changes
      } else {
        proxyOption.style.display = 'block';
      }
    }

    // Update TTL select state based on proxy checkbox
    function updateTTLState() {
      const proxyCheckbox = document.getElementById('dns-proxy-checkbox');
      const ttlSelect = document.getElementById('dns-ttl-select');
      const ttlAutoBadge = document.getElementById('dns-ttl-auto-badge');
      const ttlHint = document.getElementById('dns-ttl-hint');

      if (proxyCheckbox.checked) {
        // Proxy enabled: disable TTL select and show Auto badge
        ttlSelect.disabled = true;
        ttlSelect.style.opacity = '0.5';
        ttlSelect.style.cursor = 'not-allowed';
        ttlAutoBadge.classList.remove('hidden');
        ttlHint.textContent = 'Proxy æ¨¡å¼ä¸‹ TTL ç”± Cloudflare è‡ªåŠ¨ç®¡ç†ï¼ˆé€šå¸¸ä¸º 5 åˆ†é’Ÿï¼‰';
      } else {
        // Proxy disabled: enable TTL select
        ttlSelect.disabled = false;
        ttlSelect.style.opacity = '1';
        ttlSelect.style.cursor = 'default';
        ttlAutoBadge.classList.add('hidden');
        ttlHint.textContent = 'TTL å†³å®š DNS è®°å½•åœ¨ç¼“å­˜ä¸­ä¿ç•™çš„æ—¶é—´';
      }
    }

    // Add DNS record
    async function addDNSRecord() {
      const typeSelect = document.getElementById('dns-type-select');
      const nameInput = document.getElementById('dns-name-input');
      const contentInput = document.getElementById('dns-content-input');
      const ttlSelect = document.getElementById('dns-ttl-select');
      const proxyCheckbox = document.getElementById('dns-proxy-checkbox');

      const type = typeSelect.value;
      const name = nameInput.value.trim() || '@';
      const content = contentInput.value.trim();
      const ttl = parseInt(ttlSelect.value, 10);
      const proxied = proxyCheckbox.checked;

      if (!content) {
        showError('è¯·è¾“å…¥è®°å½•å†…å®¹');
        return;
      }

      // Validate name format (@ or subdomain label)
      if (name !== '@') {
        if (type === 'TXT') {
          // TXT records can have underscores (like _acme-challenge)
          if (!/^[a-z0-9_]([a-z0-9_-]*[a-z0-9_])?(\.[a-z0-9_]([a-z0-9_-]*[a-z0-9_])?)*$/.test(name)) {
            showError('Name æ ¼å¼é”™è¯¯ï¼šTXT è®°å½•å¿…é¡»æ˜¯ _acme-challenge æˆ– _acme-challenge.subdomain');
            return;
          }
          // Validate TXT prefix
          if (!name.startsWith('_acme-challenge')) {
            showError('TXT è®°å½•ä»…é™ Let\'s Encrypt éªŒè¯ï¼ŒName å¿…é¡»ä»¥ _acme-challenge å¼€å¤´');
            return;
          }
        } else {
          if (!/^[a-z0-9]([a-z0-9-]*[a-z0-9])?$/.test(name)) {
            showError('Name æ ¼å¼é”™è¯¯ï¼šå¿…é¡»æ˜¯ @ æˆ–æœ‰æ•ˆçš„å­åŸŸåï¼ˆåªå…è®¸å°å†™å­—æ¯ã€æ•°å­—å’Œè¿å­—ç¬¦ï¼Œä¸èƒ½ä»¥è¿å­—ç¬¦å¼€å¤´æˆ–ç»“å°¾ï¼‰');
            return;
          }
        }
      }

      if (currentDNSRecords.length >= 10) {
        showError('æœ€å¤šåªèƒ½æ·»åŠ  10 æ¡ DNS è®°å½•');
        return;
      }

      const btn = document.getElementById('add-dns-btn');
      btn.disabled = true;
      btn.textContent = 'æ·»åŠ ä¸­...';
      clearMessages();

      try {
        await api('POST', '/api/dns-records', {
          type: type,
          name: name,
          content: content,
          ttl: ttl,
          proxied: proxied
        });

        // Reload domain to get updated records
        await loadDomain();
        nameInput.value = '';
        contentInput.value = '';
        const proxyText = proxied ? 'ï¼ˆå·²å¯ç”¨ CDNï¼‰' : '';
        const nameText = name === '@' ? 'æ ¹åŸŸå' : name;
        showSuccess(`${type} è®°å½•æ·»åŠ æˆåŠŸ (${nameText})${proxyText}ï¼DNS ç”Ÿæ•ˆå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿã€‚`);
      } catch (e) {
        showError('æ·»åŠ å¤±è´¥: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'æ·»åŠ è®°å½•';
      }
    }

    // Delete DNS record
    async function deleteDNSRecord(recordId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ DNS è®°å½•å—ï¼Ÿ')) {
        return;
      }

      clearMessages();

      try {
        await api('DELETE', `/api/dns-records/${recordId}`);
        await loadDomain();
        showSuccess('DNS è®°å½•å·²åˆ é™¤');
      } catch (e) {
        showError('åˆ é™¤å¤±è´¥: ' + e.message);
      }
    }

    // Clear all DNS records
    async function clearAllDNS() {
      if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ DNS è®°å½•å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰è§£æè®°å½•ã€‚')) {
        return;
      }

      const btn = document.getElementById('clear-dns-btn');
      btn.disabled = true;
      btn.textContent = 'æ¸…é™¤ä¸­...';
      clearMessages();

      try {
        // Delete all records one by one
        for (const record of currentDNSRecords) {
          await api('DELETE', `/api/dns-records/${record.id}`);
        }
        await loadDomain();
        showSuccess('æ‰€æœ‰ DNS è®°å½•å·²æ¸…é™¤');
      } catch (e) {
        showError('æ¸…é™¤å¤±è´¥: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'æ¸…é™¤æ‰€æœ‰ DNS è®°å½•';
      }
    }

    // Submit payment form (POST)
    function submitPaymentForm(submitUrl, formData) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = submitUrl;

      for (const [key, value] of Object.entries(formData)) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        form.appendChild(input);
      }

      document.body.appendChild(form);
      form.submit();
    }

    // Register domain - Step 1: Show detail form
    document.getElementById('register-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const input = document.getElementById('label-input');
      const label = input.value.toLowerCase().trim();

      // Basic validation
      if (!label || label.length < 2 || label.length > 63) {
        showError('åŸŸåé•¿åº¦å¿…é¡»åœ¨ 2-63 å­—ç¬¦ä¹‹é—´');
        return;
      }

      if (!/^[a-z0-9]([a-z0-9-]*[a-z0-9])?$/.test(label)) {
        showError('åŸŸååªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œè¿å­—ç¬¦ï¼Œä¸”ä¸èƒ½ä»¥è¿å­—ç¬¦å¼€å¤´æˆ–ç»“å°¾');
        return;
      }

      // Store label and show detail form
      pendingLabel = label;
      document.getElementById('register-domain-display').textContent = `${label}.PY.KG`;

      // Hide register section, show detail section
      registerSection.classList.add('hidden');
      registerDetailSection.classList.remove('hidden');
      clearMessages();
    });

    // Back to label selection
    document.getElementById('back-to-label-btn').addEventListener('click', () => {
      registerDetailSection.classList.add('hidden');
      registerSection.classList.remove('hidden');
      clearMessages();
    });

    // Register domain - Step 2: Submit with praise and purpose
    document.getElementById('register-detail-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('pay-btn');
      const pythonPraise = document.getElementById('python-praise-input').value.trim();
      const usagePurpose = document.getElementById('usage-purpose-input').value.trim();

      // Validate
      if (pythonPraise.length < 20) {
        showError('å¯¹ Python çš„èµç¾è‡³å°‘éœ€è¦ 20 ä¸ªå­—ç¬¦');
        return;
      }

      if (usagePurpose.length < 10) {
        showError('ä½¿ç”¨ç”¨é€”è¯´æ˜è‡³å°‘éœ€è¦ 10 ä¸ªå­—ç¬¦');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'å¤„ç†ä¸­...';
      clearMessages();

      try {
        const data = await api('POST', '/api/domains', {
          label: pendingLabel,
          python_praise: pythonPraise,
          usage_purpose: usagePurpose,
        });

        // Submit payment form (POST)
        if (data.submit_url && data.form_data) {
          submitPaymentForm(data.submit_url, data.form_data);
        } else if (data.requires_review) {
          // Manual review required
          showSuccess(data.message || 'æ‚¨çš„åŸŸåç”³è¯·éœ€è¦äººå·¥å®¡æ ¸ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚');
          registerDetailSection.classList.add('hidden');
          setTimeout(() => window.location.reload(), 2000);
        } else {
          showError('æœªè·å–åˆ°æ”¯ä»˜è¡¨å•æ•°æ®');
          btn.disabled = false;
          btn.textContent = 'æ”¯ä»˜å¹¶å®Œæˆæ³¨å†Œ';
        }
      } catch (e) {
        showError('æ³¨å†Œå¤±è´¥: ' + e.message);
        btn.disabled = false;
        btn.textContent = 'æ”¯ä»˜å¹¶å®Œæˆæ³¨å†Œ';
      }
    });

    // Delete domain
    document.getElementById('delete-domain-btn').addEventListener('click', async () => {
      if (!confirm('ç¡®å®šè¦åˆ é™¤åŸŸåå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œæ‰€æœ‰ NS è®°å½•å°†è¢«åˆ é™¤ã€‚')) {
        return;
      }

      const btn = document.getElementById('delete-domain-btn');
      btn.disabled = true;
      btn.textContent = 'åˆ é™¤ä¸­...';
      clearMessages();

      try {
        await api('DELETE', '/api/domains');
        showSuccess('åŸŸåå·²åˆ é™¤');
        currentDomain = null;
        currentDNSRecords = [];
        currentDNSMode = null;
        domainSection.classList.add('hidden');
        dnsSection.classList.add('hidden');
        registerSection.classList.remove('hidden');
      } catch (e) {
        showError('åˆ é™¤å¤±è´¥: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'åˆ é™¤åŸŸå';
      }
    });

    // Event listeners for DNS records
    document.getElementById('dns-type-select').addEventListener('change', updateDNSTypeHint);
    document.getElementById('dns-proxy-checkbox').addEventListener('change', updateTTLState);
    document.getElementById('add-dns-btn').addEventListener('click', addDNSRecord);

    // Add Enter key support for both name and content inputs
    document.getElementById('dns-name-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addDNSRecord();
      }
    });
    document.getElementById('dns-content-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addDNSRecord();
      }
    });

    document.getElementById('clear-dns-btn').addEventListener('click', clearAllDNS);

    // Initialize DNS type hint and TTL state
    updateDNSTypeHint();
    updateTTLState();

    // Notifications functionality
    async function loadNotifications() {
      try {
        const data = await api('GET', '/api/notifications');
        const notifications = data.notifications || [];

        // Update unread count
        unreadNotifications = notifications.filter(n => n.is_read === 0);
        const unreadBadge = document.getElementById('unread-badge');
        if (unreadNotifications.length > 0) {
          unreadBadge.textContent = unreadNotifications.length;
          unreadBadge.classList.remove('hidden');
        } else {
          unreadBadge.classList.add('hidden');
        }

        // Render notifications list
        const notificationsList = document.getElementById('notifications-list');
        if (notifications.length === 0) {
          notificationsList.innerHTML = '<div class="empty-state">æš‚æ— æ¶ˆæ¯</div>';
        } else {
          notificationsList.innerHTML = notifications.map(n => `
            <div class="card" style="margin-bottom: 0.75rem; padding: 1rem; ${n.is_read === 0 ? 'border-left: 3px solid var(--primary);' : ''}">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                <strong style="color: ${n.is_read === 0 ? 'var(--primary)' : 'var(--text)'};">${escapeHtml(n.title)}</strong>
                <span style="font-size: 0.75rem; color: var(--text-muted);">${new Date(n.created_at).toLocaleString('zh-CN')}</span>
              </div>
              <p style="margin: 0; font-size: 0.875rem; color: var(--text-muted);">${escapeHtml(n.message)}</p>
              ${n.is_read === 0 ? `<button class="btn btn-secondary btn-sm" style="margin-top: 0.5rem;" onclick="markAsRead(${n.id})">æ ‡è®°å·²è¯»</button>` : ''}
            </div>
          `).join('');
        }
      } catch (e) {
        console.error('Failed to load notifications:', e);
      }
    }

    async function markAsRead(id) {
      try {
        await api('POST', '/api/notifications', { id });
        await loadNotifications();
      } catch (e) {
        showError('æ ‡è®°å¤±è´¥: ' + e.message);
      }
    }

    async function markAllAsRead() {
      try {
        await api('POST', '/api/notifications', { mark_all: true });
        await loadNotifications();
      } catch (e) {
        showError('æ ‡è®°å¤±è´¥: ' + e.message);
      }
    }

    window.markAsRead = markAsRead;

    document.getElementById('notifications-btn').addEventListener('click', () => {
      document.getElementById('notifications-panel').classList.toggle('hidden');
      if (!document.getElementById('notifications-panel').classList.contains('hidden')) {
        loadNotifications();
      }
    });

    document.getElementById('close-notifications-btn').addEventListener('click', () => {
      document.getElementById('notifications-panel').classList.add('hidden');
    });

    document.getElementById('mark-all-read-btn').addEventListener('click', markAllAsRead);

    // Load appeal status for suspended domains
    async function loadAppealStatus() {
      try {
        const data = await api('GET', '/api/appeals');
        const appeals = data.appeals || [];
        const pendingAppeal = appeals.find(a => a.status === 'pending');
        const appealSection = document.getElementById('appeal-section');

        if (pendingAppeal) {
          // Show pending appeal status instead of form
          appealSection.innerHTML = `
            <h2>ç”³è¯‰çŠ¶æ€</h2>
            <div class="alert alert-info" style="margin-bottom: 1rem;">
              <strong>æ‚¨çš„ç”³è¯‰æ­£åœ¨å¤„ç†ä¸­</strong><br>
              è¯·è€å¿ƒç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸ã€‚
            </div>
            <div style="margin-bottom: 1rem;">
              <p><strong>ç”³è¯‰åŸå› ï¼š</strong></p>
              <p style="background: var(--bg); padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem;">${escapeHtml(pendingAppeal.reason)}</p>
              <p style="color: var(--text-muted); font-size: 0.875rem; margin-top: 0.5rem;">
                <strong>æäº¤æ—¶é—´ï¼š</strong>${new Date(pendingAppeal.created_at).toLocaleString('zh-CN')}
              </p>
            </div>
          `;
          appealSection.classList.remove('hidden');
        } else {
          // Show appeal form
          appealSection.innerHTML = `
            <h2>ç”³è¯‰è§£å°</h2>
            <div class="alert alert-warning" style="margin-bottom: 1rem;">
              æ‚¨çš„åŸŸåå·²è¢«æš‚åœï¼Œå¦‚æœæ‚¨è®¤ä¸ºè¿™æ˜¯è¯¯åˆ¤ï¼Œå¯ä»¥æäº¤ç”³è¯‰ã€‚
            </div>
            <form id="appeal-form">
              <div class="form-group">
                <label for="appeal-reason">ç”³è¯‰åŸå›  <span style="color: var(--danger);">*</span></label>
                <textarea
                  id="appeal-reason"
                  rows="5"
                  placeholder="è¯·è¯¦ç»†è¯´æ˜æ‚¨è®¤ä¸ºåŸŸåè¢«æš‚åœçš„åŸå› ä¸æˆç«‹ï¼Œæˆ–è€…æ‚¨å·²ç»æ•´æ”¹å®Œæˆ..."
                  required
                  minlength="10"
                  style="width: 100%; padding: 0.625rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.875rem; font-family: inherit; resize: vertical;"
                ></textarea>
                <small style="color: var(--text-muted); margin-top: 0.25rem; display: block;">
                  è¯·è‡³å°‘è¾“å…¥ 10 ä¸ªå­—ç¬¦
                </small>
              </div>
              <button type="submit" class="btn btn-primary">æäº¤ç”³è¯‰</button>
            </form>
          `;
          appealSection.classList.remove('hidden');

          // Re-attach form submit handler
          document.getElementById('appeal-form').addEventListener('submit', handleAppealSubmit);
        }
      } catch (e) {
        console.error('Failed to load appeal status:', e);
        // Show appeal form as fallback
        document.getElementById('appeal-section').classList.remove('hidden');
      }
    }

    // Appeal form submit handler
    async function handleAppealSubmit(e) {
      e.preventDefault();
      const reason = document.getElementById('appeal-reason').value.trim();

      if (reason.length < 10) {
        showError('ç”³è¯‰åŸå› è‡³å°‘éœ€è¦10ä¸ªå­—ç¬¦');
        return;
      }

      try {
        const data = await api('POST', '/api/appeals', { reason });
        showSuccess(data.message || 'ç”³è¯‰å·²æäº¤');
        // Reload appeal status to show pending state
        await loadAppealStatus();
      } catch (e) {
        showError('æäº¤å¤±è´¥: ' + e.message);
      }
    }

    // Appeal functionality (initial form handler, will be replaced by loadAppealStatus)
    document.getElementById('appeal-form').addEventListener('submit', handleAppealSubmit);

    // Continue payment for pending order
    document.getElementById('continue-pay-btn').addEventListener('click', async () => {
      if (!pendingOrder) return;

      const btn = document.getElementById('continue-pay-btn');
      btn.disabled = true;
      btn.textContent = 'è·³è½¬ä¸­...';

      try {
        // Re-submit with the same label to get payment form
        const data = await api('POST', '/api/domains', { label: pendingOrder.label });
        if (data.submit_url && data.form_data) {
          submitPaymentForm(data.submit_url, data.form_data);
        } else {
          showError('æœªè·å–åˆ°æ”¯ä»˜è¡¨å•æ•°æ®');
          btn.disabled = false;
          btn.textContent = 'ç»§ç»­æ”¯ä»˜';
        }
      } catch (e) {
        showError('è·å–æ”¯ä»˜è¡¨å•å¤±è´¥: ' + e.message);
        btn.disabled = false;
        btn.textContent = 'ç»§ç»­æ”¯ä»˜';
      }
    });

    // Refresh status button - simply reload the page
    document.getElementById('refresh-status-btn').addEventListener('click', () => {
      window.location.reload();
    });

    // Refresh review status button - simply reload the page
    document.getElementById('refresh-review-status-btn').addEventListener('click', () => {
      window.location.reload();
    });

    // Cancel pending order
    document.getElementById('cancel-order-btn').addEventListener('click', async () => {
      if (!pendingOrder) return;

      if (!confirm('ç¡®å®šè¦å–æ¶ˆæ­¤è®¢å•å—ï¼Ÿå–æ¶ˆåå¯ä»¥é‡æ–°æ³¨å†Œå…¶ä»–åŸŸåã€‚')) {
        return;
      }

      const btn = document.getElementById('cancel-order-btn');
      btn.disabled = true;
      btn.textContent = 'å–æ¶ˆä¸­...';
      clearMessages();

      try {
        await api('DELETE', '/api/orders/' + pendingOrder.order_no);
        showSuccess('è®¢å•å·²å–æ¶ˆ');
        pendingOrder = null;
        pendingOrderSection.classList.add('hidden');
        registerSection.classList.remove('hidden');
      } catch (e) {
        showError('å–æ¶ˆè®¢å•å¤±è´¥: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'å–æ¶ˆè®¢å•';
      }
    });

    // Initialize
    checkUrlError();
    loadUser();
  </script>
</body>
</html>
