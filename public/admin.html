<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†åå° - PY.KG</title>
  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --danger: #dc2626;
      --danger-hover: #b91c1c;
      --success: #16a34a;
      --warning: #d97706;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    .admin-layout {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 250px;
      background: var(--card-bg);
      border-right: 1px solid var(--border);
      padding: 1.5rem;
    }

    .sidebar h1 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: var(--primary);
    }

    .sidebar p {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-bottom: 2rem;
    }

    .nav-menu {
      list-style: none;
    }

    .nav-item {
      margin-bottom: 0.5rem;
    }

    .nav-link {
      display: block;
      padding: 0.75rem 1rem;
      border-radius: 6px;
      text-decoration: none;
      color: var(--text);
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .nav-link:hover {
      background: var(--bg);
    }

    .nav-link.active {
      background: var(--primary);
      color: white;
    }

    .main-content {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .card {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .card h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 1.5rem;
    }

    .stat-card h3 {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .stat-card .value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--primary);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      font-size: 0.875rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.625rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.875rem;
    }

    .form-group input[type="checkbox"] {
      width: auto;
      margin-right: 0.5rem;
    }

    .btn {
      display: inline-block;
      padding: 0.625rem 1.25rem;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: background-color 0.2s;
      margin-right: 0.5rem;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: var(--danger-hover);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-secondary {
      background: var(--text-muted);
      color: white;
    }

    .table-container {
      overflow-x: auto;
      margin-top: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      font-weight: 600;
      background: var(--bg);
      font-size: 0.875rem;
    }

    td {
      font-size: 0.875rem;
    }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.625rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .badge-success {
      background: #dcfce7;
      color: var(--success);
    }

    .badge-danger {
      background: #fee2e2;
      color: var(--danger);
    }

    .badge-warning {
      background: #fef3c7;
      color: var(--warning);
    }

    .badge-info {
      background: #dbeafe;
      color: var(--primary);
    }

    .search-bar {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .search-bar input {
      flex: 1;
    }

    .alert {
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .alert-success {
      background: #dcfce7;
      color: var(--success);
    }

    .alert-error {
      background: #fee2e2;
      color: var(--danger);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
    }

    .modal-header {
      margin-bottom: 1rem;
    }

    .modal-header h3 {
      font-size: 1.25rem;
    }

    .modal-footer {
      margin-top: 1.5rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-muted);
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .action-buttons button {
      padding: 0.375rem 0.75rem;
      font-size: 0.75rem;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="loading">æ­£åœ¨åŠ è½½...</div>
  </div>

  <script>
    const API_BASE = '';
    let currentUser = null;
    let stats = null;

    // æ£€æŸ¥ç®¡ç†å‘˜æƒé™å¹¶åˆå§‹åŒ–
    async function init() {
      try {
        const res = await fetch('/api/me');
        if (!res.ok) {
          window.location.href = '/';
          return;
        }
        const data = await res.json();
        currentUser = data.data.user;

        if (!currentUser.is_admin) {
          alert('éœ€è¦ç®¡ç†å‘˜æƒé™');
          window.location.href = '/';
          return;
        }

        renderLayout();
        await loadStats();
        showPage('dashboard');
      } catch (error) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        alert('åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
      }
    }

    // æ¸²æŸ“å¸ƒå±€
    function renderLayout() {
      document.getElementById('app').innerHTML = `
        <div class="admin-layout">
          <div class="sidebar">
            <h1>PY.KG</h1>
            <p>ç®¡ç†åå°</p>
            <ul class="nav-menu">
              <li class="nav-item">
                <a class="nav-link active" onclick="showPage('dashboard', event)">ä»ªè¡¨æ¿</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" onclick="showPage('settings', event)">ç³»ç»Ÿè®¾ç½®</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" onclick="showPage('users', event)">ç”¨æˆ·ç®¡ç†</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" onclick="showPage('domains', event)">åŸŸåç®¡ç†</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" onclick="showPage('reviews', event)">å®¡æ ¸ç®¡ç†</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" onclick="showPage('appeals', event)">ç”³è¯‰ç®¡ç†</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" onclick="showPage('reports', event)">ä¸¾æŠ¥ç®¡ç†</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" onclick="showPage('banned-words', event)">æ•æ„Ÿè¯ç®¡ç†</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/">è¿”å›é¦–é¡µ</a>
              </li>
            </ul>
          </div>
          <div class="main-content">
            <div id="dashboard" class="page active">
              <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            <div id="settings" class="page">
              <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            <div id="users" class="page">
              <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            <div id="domains" class="page">
              <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            <div id="reviews" class="page">
              <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            <div id="appeals" class="page">
              <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            <div id="reports" class="page">
              <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            <div id="banned-words" class="page">
              <div class="loading">åŠ è½½ä¸­...</div>
            </div>
          </div>
        </div>
      `;
    }

    // åˆ‡æ¢é¡µé¢
    function showPage(pageName, event) {
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));

      const page = document.getElementById(pageName);
      if (page) {
        page.classList.add('active');

        // æ¿€æ´»å¯¹åº”çš„å¯¼èˆªé“¾æ¥
        if (event && event.target) {
          event.target.classList.add('active');
        } else {
          // æ²¡æœ‰ event æ—¶ï¼Œé€šè¿‡ pageName æ‰¾åˆ°å¯¹åº”çš„å¯¼èˆªé“¾æ¥
          const navLinks = document.querySelectorAll('.nav-link');
          navLinks.forEach(link => {
            if (link.textContent.includes(getPageTitle(pageName))) {
              link.classList.add('active');
            }
          });
        }

        // åŠ è½½é¡µé¢æ•°æ®
        switch(pageName) {
          case 'dashboard':
            loadDashboard();
            break;
          case 'settings':
            loadSettings();
            break;
          case 'users':
            loadUsers();
            break;
          case 'domains':
            loadDomains();
            break;
          case 'reviews':
            loadReviews();
            break;
          case 'appeals':
            loadAppeals();
            break;
          case 'reports':
            loadReports();
            break;
          case 'banned-words':
            loadBannedWords();
            break;
        }
      }
    }

    function getPageTitle(pageName) {
      const titles = {
        'dashboard': 'ä»ªè¡¨æ¿',
        'settings': 'ç³»ç»Ÿè®¾ç½®',
        'users': 'ç”¨æˆ·ç®¡ç†',
        'domains': 'åŸŸåç®¡ç†',
        'reviews': 'å®¡æ ¸ç®¡ç†',
        'appeals': 'ç”³è¯‰ç®¡ç†',
        'reports': 'ä¸¾æŠ¥ç®¡ç†',
        'banned-words': 'æ•æ„Ÿè¯ç®¡ç†'
      };
      return titles[pageName] || '';
    }

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStats() {
      try {
        const res = await fetch('/api/admin/stats');
        if (!res.ok) {
          console.warn('Stats API returned', res.status);
          // 429 æˆ–å…¶ä»–é”™è¯¯æ—¶ä½¿ç”¨é»˜è®¤å€¼
          stats = {
            totalUsers: 0,
            totalDomains: 0,
            pendingReviews: 0,
            totalOrders: 0,
            totalRevenue: 0
          };
          return;
        }
        const data = await res.json();
        if (data.success) {
          stats = data.data;
        }
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
        // ä½¿ç”¨é»˜è®¤å€¼
        stats = {
          totalUsers: 0,
          totalDomains: 0,
          pendingReviews: 0,
          totalOrders: 0,
          totalRevenue: 0
        };
      }
    }

    // ä»ªè¡¨æ¿é¡µé¢
    function loadDashboard() {
      const page = document.getElementById('dashboard');
      page.innerHTML = `
        <h1 style="margin-bottom: 1.5rem;">ä»ªè¡¨æ¿</h1>
        <div class="stats-grid">
          <div class="stat-card">
            <h3>æ€»ç”¨æˆ·æ•°</h3>
            <div class="value">${stats?.totalUsers || 0}</div>
          </div>
          <div class="stat-card">
            <h3>æ€»åŸŸåæ•°</h3>
            <div class="value">${stats?.totalDomains || 0}</div>
          </div>
          <div class="stat-card">
            <h3>å¾…å®¡æ ¸</h3>
            <div class="value">${stats?.pendingReviews || 0}</div>
          </div>
          <div class="stat-card">
            <h3>æ€»è®¢å•æ•°</h3>
            <div class="value">${stats?.totalOrders || 0}</div>
          </div>
          <div class="stat-card">
            <h3>æ€»æ”¶å…¥</h3>
            <div class="value">${stats?.totalRevenue || 0}</div>
          </div>
        </div>
      `;
    }

    // ç³»ç»Ÿè®¾ç½®é¡µé¢
    async function loadSettings() {
      const page = document.getElementById('settings');
      page.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      try {
        const res = await fetch('/api/admin/settings');
        const data = await res.json();

        if (data.success) {
          const settings = data.data;
          page.innerHTML = `
            <h1 style="margin-bottom: 1.5rem;">ç³»ç»Ÿè®¾ç½®</h1>
            <div id="settings-alert"></div>
            <div class="card">
              <h2>åŸºæœ¬è®¾ç½®</h2>
              <form id="settings-form">
                <div class="form-group">
                  <label>åŸŸåä»·æ ¼ (Credit)</label>
                  <input type="number" name="domain_price" value="${settings.domain_price}" required min="0" step="1">
                </div>
                <div class="form-group">
                  <label>
                    <input type="checkbox" name="require_review" ${settings.require_review === 'true' ? 'checked' : ''}>
                    å¼€å¯äººå·¥å®¡æ ¸
                  </label>
                  <p style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.25rem;">
                    å¼€å¯åï¼Œæ‰€æœ‰åŸŸåæ³¨å†Œéƒ½éœ€è¦ç®¡ç†å‘˜å®¡æ ¸
                  </p>
                </div>
                <div class="form-group">
                  <label>æ¯ç”¨æˆ·æœ€å¤§åŸŸåæ•°</label>
                  <input type="number" name="max_domains_per_user" value="${settings.max_domains_per_user}" required min="1" step="1">
                </div>
                <button type="submit" class="btn btn-primary">ä¿å­˜è®¾ç½®</button>
              </form>
            </div>
          `;

          document.getElementById('settings-form').addEventListener('submit', saveSettings);
        }
      } catch (error) {
        page.innerHTML = '<div class="alert alert-error">åŠ è½½å¤±è´¥</div>';
      }
    }

    async function saveSettings(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);

      const settings = {
        domain_price: formData.get('domain_price'),
        require_review: formData.get('require_review') ? 'true' : 'false',
        max_domains_per_user: formData.get('max_domains_per_user')
      };

      try {
        const res = await fetch('/api/admin/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });

        const data = await res.json();
        const alertDiv = document.getElementById('settings-alert');

        if (data.success) {
          alertDiv.innerHTML = '<div class="alert alert-success">è®¾ç½®å·²ä¿å­˜</div>';
          setTimeout(() => alertDiv.innerHTML = '', 3000);
        } else {
          alertDiv.innerHTML = `<div class="alert alert-error">${data.error || 'ä¿å­˜å¤±è´¥'}</div>`;
        }
      } catch (error) {
        document.getElementById('settings-alert').innerHTML = '<div class="alert alert-error">ä¿å­˜å¤±è´¥</div>';
      }
    }

    // ç”¨æˆ·ç®¡ç†é¡µé¢
    async function loadUsers(search = '', filter = 'all') {
      const page = document.getElementById('users');
      page.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      try {
        const params = new URLSearchParams({ search, filter, limit: 100 });
        const res = await fetch(`/api/admin/users?${params}`);
        const data = await res.json();

        if (data.success) {
          const users = data.data.users;
          page.innerHTML = `
            <h1 style="margin-bottom: 1.5rem;">ç”¨æˆ·ç®¡ç†</h1>
            <div id="users-alert"></div>
            <div class="card">
              <div class="search-bar">
                <input type="text" id="user-search" placeholder="æœç´¢ç”¨æˆ·åæˆ–LinuxDO ID" value="${search}">
                <select id="user-filter" value="${filter}">
                  <option value="all">å…¨éƒ¨</option>
                  <option value="banned">å·²å°ç¦</option>
                  <option value="admin">ç®¡ç†å‘˜</option>
                </select>
                <button class="btn btn-primary" onclick="searchUsers()">æœç´¢</button>
              </div>
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>LinuxDO ID</th>
                      <th>ç”¨æˆ·å</th>
                      <th>ä¿¡ä»»ç­‰çº§</th>
                      <th>çŠ¶æ€</th>
                      <th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${users.length === 0 ? '<tr><td colspan="5" class="empty-state">æ— æ•°æ®</td></tr>' : users.map(user => `
                      <tr>
                        <td>${user.linuxdo_id}</td>
                        <td>${user.username}</td>
                        <td>TL${user.trust_level}</td>
                        <td>
                          ${user.is_banned ? '<span class="badge badge-danger">å·²å°ç¦</span>' : ''}
                          ${user.is_admin ? '<span class="badge badge-info">ç®¡ç†å‘˜</span>' : ''}
                        </td>
                        <td>
                          <div class="action-buttons">
                            ${!user.is_banned ? `<button class="btn btn-danger" onclick="banUser(${user.linuxdo_id})">å°ç¦</button>` : `<button class="btn btn-success" onclick="unbanUser(${user.linuxdo_id})">è§£å°</button>`}
                            ${!user.is_admin ? `<button class="btn btn-primary" onclick="setAdmin(${user.linuxdo_id}, true)">è®¾ä¸ºç®¡ç†å‘˜</button>` : `<button class="btn btn-secondary" onclick="setAdmin(${user.linuxdo_id}, false)">å–æ¶ˆç®¡ç†å‘˜</button>`}
                          </div>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          `;
        }
      } catch (error) {
        page.innerHTML = '<div class="alert alert-error">åŠ è½½å¤±è´¥</div>';
      }
    }

    function searchUsers() {
      const search = document.getElementById('user-search').value;
      const filter = document.getElementById('user-filter').value;
      loadUsers(search, filter);
    }

    async function banUser(linuxdoId) {
      const reason = prompt('è¯·è¾“å…¥å°ç¦åŸå› :');
      if (!reason) return;

      try {
        const res = await fetch('/api/admin/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ linuxdo_id: linuxdoId, action: 'ban', reason })
        });

        const data = await res.json();
        if (data.success) {
          showAlert('users-alert', 'ç”¨æˆ·å·²å°ç¦', 'success');
          loadUsers();
        } else {
          showAlert('users-alert', data.error || 'æ“ä½œå¤±è´¥', 'error');
        }
      } catch (error) {
        showAlert('users-alert', 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    async function unbanUser(linuxdoId) {
      try {
        const res = await fetch('/api/admin/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ linuxdo_id: linuxdoId, action: 'unban' })
        });

        const data = await res.json();
        if (data.success) {
          showAlert('users-alert', 'ç”¨æˆ·å·²è§£å°', 'success');
          loadUsers();
        } else {
          showAlert('users-alert', data.error || 'æ“ä½œå¤±è´¥', 'error');
        }
      } catch (error) {
        showAlert('users-alert', 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    async function setAdmin(linuxdoId, isAdmin) {
      const action = isAdmin ? 'set_admin' : 'remove_admin';

      try {
        const res = await fetch('/api/admin/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ linuxdo_id: linuxdoId, action })
        });

        const data = await res.json();
        if (data.success) {
          showAlert('users-alert', isAdmin ? 'å·²è®¾ä¸ºç®¡ç†å‘˜' : 'å·²å–æ¶ˆç®¡ç†å‘˜', 'success');
          loadUsers();
        } else {
          showAlert('users-alert', data.error || 'æ“ä½œå¤±è´¥', 'error');
        }
      } catch (error) {
        showAlert('users-alert', 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    // åŸŸåç®¡ç†é¡µé¢
    async function loadDomains(search = '', status = 'all') {
      const page = document.getElementById('domains');
      page.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      try {
        const params = new URLSearchParams({ search, status, limit: 100 });
        const res = await fetch(`/api/admin/domains?${params}`);
        const data = await res.json();

        if (data.success) {
          const domains = data.data.domains;
          page.innerHTML = `
            <h1 style="margin-bottom: 1.5rem;">åŸŸåç®¡ç†</h1>
            <div id="domains-alert"></div>
            <div class="card">
              <div class="search-bar">
                <input type="text" id="domain-search" placeholder="æœç´¢åŸŸåæˆ–ç”¨æˆ·å" value="${search}">
                <select id="domain-status" value="${status}">
                  <option value="all">å…¨éƒ¨</option>
                  <option value="active">æ´»è·ƒ</option>
                  <option value="suspended">å·²æš‚åœ</option>
                  <option value="pending">å¾…æ”¯ä»˜</option>
                  <option value="review">å¾…å®¡æ ¸</option>
                </select>
                <button class="btn btn-primary" onclick="searchDomains()">æœç´¢</button>
              </div>
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>åŸŸå</th>
                      <th>æ‰€æœ‰è€…</th>
                      <th>çŠ¶æ€</th>
                      <th>åˆ›å»ºæ—¶é—´</th>
                      <th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${domains.length === 0 ? '<tr><td colspan="5" class="empty-state">æ— æ•°æ®</td></tr>' : domains.map(domain => `
                      <tr>
                        <td>${domain.fqdn}</td>
                        <td>${domain.owner_username || 'æœªçŸ¥'} (${domain.owner_linuxdo_id})</td>
                        <td>
                          ${domain.status === 'active' ? '<span class="badge badge-success">æ´»è·ƒ</span>' : ''}
                          ${domain.status === 'suspended' ? '<span class="badge badge-danger">å·²æš‚åœ</span>' : ''}
                          ${domain.status === 'pending' ? '<span class="badge badge-warning">å¾…æ”¯ä»˜</span>' : ''}
                          ${domain.status === 'review' ? '<span class="badge badge-info">å¾…å®¡æ ¸</span>' : ''}
                        </td>
                        <td>${new Date(domain.created_at).toLocaleString('zh-CN')}</td>
                        <td>
                          <div class="action-buttons">
                            <button class="btn btn-info btn-sm" onclick="manageDNSRecords(${domain.id}, '${domain.fqdn}')">DNSè®°å½•</button>
                            ${domain.status === 'active' ? `<button class="btn btn-warning btn-sm" onclick="suspendDomain(${domain.id})">æš‚åœ</button>` : ''}
                            ${domain.status === 'suspended' ? `<button class="btn btn-success btn-sm" onclick="activateDomain(${domain.id})">æ¿€æ´»</button>` : ''}
                            <button class="btn btn-danger btn-sm" onclick="deleteDomain(${domain.id})">åˆ é™¤</button>
                          </div>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          `;
        }
      } catch (error) {
        page.innerHTML = '<div class="alert alert-error">åŠ è½½å¤±è´¥</div>';
      }
    }

    function searchDomains() {
      const search = document.getElementById('domain-search').value;
      const status = document.getElementById('domain-status').value;
      loadDomains(search, status);
    }

    async function suspendDomain(id) {
      const reason = prompt('è¯·è¾“å…¥æš‚åœåŸå› :');
      if (!reason) return;

      try {
        const res = await fetch('/api/admin/domains', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, action: 'suspend', reason })
        });

        const data = await res.json();
        if (data.success) {
          showAlert('domains-alert', 'åŸŸåå·²æš‚åœ', 'success');
          loadDomains();
        } else {
          showAlert('domains-alert', data.error || 'æ“ä½œå¤±è´¥', 'error');
        }
      } catch (error) {
        showAlert('domains-alert', 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    async function activateDomain(id) {
      try {
        const res = await fetch('/api/admin/domains', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, action: 'activate' })
        });

        const data = await res.json();
        if (data.success) {
          showAlert('domains-alert', 'åŸŸåå·²æ¿€æ´»', 'success');
          loadDomains();
        } else {
          showAlert('domains-alert', data.error || 'æ“ä½œå¤±è´¥', 'error');
        }
      } catch (error) {
        showAlert('domains-alert', 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    async function deleteDomain(id) {
      const reason = prompt('è¯·è¾“å…¥åˆ é™¤ç†ç”±:');
      if (reason === null) return; // ç”¨æˆ·ç‚¹å‡»å–æ¶ˆ

      try {
        const res = await fetch('/api/admin/domains', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, action: 'delete', reason })
        });

        const data = await res.json();
        if (data.success) {
          showAlert('domains-alert', 'åŸŸåå·²åˆ é™¤', 'success');
          loadDomains();
        } else {
          showAlert('domains-alert', data.error || 'æ“ä½œå¤±è´¥', 'error');
        }
      } catch (error) {
        showAlert('domains-alert', 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    // å®¡æ ¸ç®¡ç†é¡µé¢
    async function loadReviews(status = 'pending') {
      const page = document.getElementById('reviews');
      page.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      try {
        const params = new URLSearchParams({ status, limit: 100 });
        const res = await fetch(`/api/admin/reviews?${params}`);
        const data = await res.json();

        if (data.success) {
          const reviews = data.data.reviews;
          const hasPendingReviews = reviews.some(r => r.status === 'pending' && r.order_status === 'paid');

          page.innerHTML = `
            <h1 style="margin-bottom: 1.5rem;">å®¡æ ¸ç®¡ç†</h1>
            <div id="reviews-alert"></div>
            <div class="card">
              <div class="search-bar" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <select id="review-status" value="${status}">
                    <option value="pending">å¾…å®¡æ ¸</option>
                    <option value="approved">å·²æ‰¹å‡†</option>
                    <option value="rejected">å·²æ‹’ç»</option>
                  </select>
                  <button class="btn btn-primary" onclick="filterReviews()">ç­›é€‰</button>
                </div>
                ${status === 'pending' && hasPendingReviews ? `
                  <button class="btn btn-success" onclick="batchApproveReviews()">æ‰¹é‡é€šè¿‡é€‰ä¸­é¡¹</button>
                ` : ''}
              </div>
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      ${status === 'pending' ? '<th><input type="checkbox" id="select-all-reviews" onchange="toggleAllReviews(this)"></th>' : ''}
                      <th>åŸŸå</th>
                      <th>ç”¨æˆ·</th>
                      <th>Pythonèµç¾</th>
                      <th>ç”¨é€”è¯´æ˜</th>
                      <th>æ”¯ä»˜çŠ¶æ€</th>
                      <th>æäº¤æ—¶é—´</th>
                      <th>çŠ¶æ€</th>
                      <th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${reviews.length === 0 ? `<tr><td colspan="${status === 'pending' ? '9' : '8'}" class="empty-state">æ— æ•°æ®</td></tr>` : reviews.map(review => {
                      const isPaid = review.order_status === 'paid';
                      const canApprove = review.status === 'pending' && isPaid;
                      return `
                      <tr>
                        ${status === 'pending' && canApprove ? `<td><input type="checkbox" class="review-checkbox" value="${review.id}"></td>` : (status === 'pending' ? '<td></td>' : '')}
                        <td>${review.label}.py.kg</td>
                        <td>${review.username} (${review.linuxdo_id})</td>
                        <td style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${review.python_praise || '-'}">${review.python_praise || '-'}</td>
                        <td style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${review.usage_purpose || '-'}">${review.usage_purpose || '-'}</td>
                        <td>
                          ${review.order_status === 'paid' ? '<span class="badge badge-success">å·²æ”¯ä»˜</span>' : ''}
                          ${review.order_status === 'pending' ? '<span class="badge badge-warning">å¾…æ”¯ä»˜</span>' : ''}
                          ${review.order_status === 'failed' ? '<span class="badge badge-danger">æ”¯ä»˜å¤±è´¥</span>' : ''}
                          ${!review.order_status ? '<span class="badge badge-warning">æ— è®¢å•</span>' : ''}
                        </td>
                        <td>${new Date(review.created_at).toLocaleString('zh-CN')}</td>
                        <td>
                          ${review.status === 'pending' ? '<span class="badge badge-warning">å¾…å®¡æ ¸</span>' : ''}
                          ${review.status === 'approved' ? '<span class="badge badge-success">å·²æ‰¹å‡†</span>' : ''}
                          ${review.status === 'rejected' ? '<span class="badge badge-danger">å·²æ‹’ç»</span>' : ''}
                        </td>
                        <td>
                          ${review.status === 'pending' ? `
                            <div class="action-buttons">
                              <button class="btn btn-success btn-sm" onclick="approveReview(${review.id})" ${!canApprove ? 'disabled title="è®¢å•æœªæ”¯ä»˜"' : ''}>æ‰¹å‡†</button>
                              <button class="btn btn-danger btn-sm" onclick="rejectReview(${review.id}, false)">æ‹’ç»</button>
                              <button class="btn btn-danger btn-sm" onclick="rejectReview(${review.id}, true)">æ‹’ç»å¹¶å°ç¦</button>
                            </div>
                          ` : '-'}
                        </td>
                      </tr>
                    `}).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          `;
        }
      } catch (error) {
        page.innerHTML = '<div class="alert alert-error">åŠ è½½å¤±è´¥</div>';
      }
    }

    function toggleAllReviews(checkbox) {
      const checkboxes = document.querySelectorAll('.review-checkbox');
      checkboxes.forEach(cb => cb.checked = checkbox.checked);
    }

    async function batchApproveReviews() {
      const checkboxes = document.querySelectorAll('.review-checkbox:checked');
      const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));

      if (ids.length === 0) {
        showAlert('reviews-alert', 'è¯·é€‰æ‹©è¦æ‰¹å‡†çš„å®¡æ ¸é¡¹', 'error');
        return;
      }

      if (!confirm(`ç¡®å®šè¦æ‰¹å‡†é€‰ä¸­çš„ ${ids.length} ä¸ªåŸŸåå—ï¼Ÿ`)) return;

      try {
        let successCount = 0;
        let failCount = 0;

        for (const id of ids) {
          const res = await fetch('/api/admin/reviews', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, action: 'approve' })
          });

          const data = await res.json();
          if (data.success) {
            successCount++;
          } else {
            failCount++;
          }
        }

        showAlert('reviews-alert', `æ‰¹é‡å®¡æ ¸å®Œæˆï¼šæˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${failCount} ä¸ª`, successCount > 0 ? 'success' : 'error');
        loadReviews();
      } catch (error) {
        showAlert('reviews-alert', 'æ‰¹é‡å®¡æ ¸å¤±è´¥', 'error');
      }
    }

    function filterReviews() {
      const status = document.getElementById('review-status').value;
      loadReviews(status);
    }

    async function approveReview(id) {
      const reason = prompt('è¯·è¾“å…¥æ‰¹å‡†ç†ç”±ï¼ˆå¯é€‰ï¼‰:');
      if (reason === null) return; // ç”¨æˆ·ç‚¹å‡»å–æ¶ˆ

      try {
        const res = await fetch('/api/admin/reviews', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, action: 'approve', reason })
        });

        const data = await res.json();
        if (data.success) {
          showAlert('reviews-alert', 'å·²æ‰¹å‡†', 'success');
          loadReviews();
          loadStats();
        } else {
          showAlert('reviews-alert', data.error || 'æ“ä½œå¤±è´¥', 'error');
        }
      } catch (error) {
        showAlert('reviews-alert', 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    async function rejectReview(id, banUser) {
      const reason = prompt('è¯·è¾“å…¥æ‹’ç»ç†ç”±:');
      if (reason === null) return; // ç”¨æˆ·ç‚¹å‡»å–æ¶ˆ

      try {
        const res = await fetch('/api/admin/reviews', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, action: 'reject', banUser, reason })
        });

        const data = await res.json();
        if (data.success) {
          showAlert('reviews-alert', banUser ? 'å·²æ‹’ç»å¹¶å°ç¦ç”¨æˆ·' : 'å·²æ‹’ç»', 'success');
          loadReviews();
          loadStats();
        } else {
          showAlert('reviews-alert', data.error || 'æ“ä½œå¤±è´¥', 'error');
        }
      } catch (error) {
        showAlert('reviews-alert', 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    // ç”³è¯‰ç®¡ç†é¡µé¢
    async function loadAppeals(status = 'pending') {
      const page = document.getElementById('appeals');
      page.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      try {
        const params = new URLSearchParams({ status, limit: 100 });
        const res = await fetch(`/api/admin/appeals?${params}`);
        const data = await res.json();

        if (data.success) {
          const appeals = data.data.appeals;
          page.innerHTML = `
            <h1 style="margin-bottom: 1.5rem;">ç”³è¯‰ç®¡ç†</h1>
            <div id="appeals-alert"></div>
            <div class="card">
              <div class="search-bar">
                <select id="appeal-status" value="${status}">
                  <option value="pending">å¾…å¤„ç†</option>
                  <option value="approved">å·²æ‰¹å‡†</option>
                  <option value="rejected">å·²æ‹’ç»</option>
                </select>
                <button class="btn btn-primary" onclick="filterAppeals()">ç­›é€‰</button>
              </div>
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>åŸŸå</th>
                      <th>ç”¨æˆ·</th>
                      <th>ç”³è¯‰åŸå› </th>
                      <th>æäº¤æ—¶é—´</th>
                      <th>çŠ¶æ€</th>
                      <th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${appeals.length === 0 ? '<tr><td colspan="6" class="empty-state">æ— æ•°æ®</td></tr>' : appeals.map(appeal => `
                      <tr>
                        <td>${appeal.fqdn}</td>
                        <td>${appeal.username} (${appeal.linuxdo_id})</td>
                        <td style="max-width: 300px; white-space: pre-wrap; word-break: break-word;">${appeal.reason}</td>
                        <td>${new Date(appeal.created_at).toLocaleString('zh-CN')}</td>
                        <td>
                          ${appeal.status === 'pending' ? '<span class="badge badge-warning">å¾…å¤„ç†</span>' : ''}
                          ${appeal.status === 'approved' ? '<span class="badge badge-success">å·²æ‰¹å‡†</span>' : ''}
                          ${appeal.status === 'rejected' ? '<span class="badge badge-danger">å·²æ‹’ç»</span>' : ''}
                        </td>
                        <td>
                          ${appeal.status === 'pending' ? `
                            <div class="action-buttons">
                              <button class="btn btn-info btn-sm" onclick="manageDNSRecords(${appeal.domain_id}, '${appeal.fqdn}')">DNSè®°å½•</button>
                              <button class="btn btn-success btn-sm" onclick="approveAppeal(${appeal.id})">æ‰¹å‡†ï¼ˆè§£å°ï¼‰</button>
                              <button class="btn btn-danger btn-sm" onclick="rejectAppeal(${appeal.id})">æ‹’ç»</button>
                            </div>
                          ` : '-'}
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          `;
        }
      } catch (error) {
        page.innerHTML = '<div class="alert alert-error">åŠ è½½å¤±è´¥</div>';
      }
    }

    function filterAppeals() {
      const status = document.getElementById('appeal-status').value;
      loadAppeals(status);
    }

    async function approveAppeal(id) {
      const admin_note = prompt('è¯·è¾“å…¥æ‰¹å‡†å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰:');
      if (admin_note === null) return;

      try {
        const res = await fetch('/api/admin/appeals', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, action: 'approve', admin_note })
        });

        const data = await res.json();
        if (data.success) {
          showAlert('appeals-alert', 'ç”³è¯‰å·²æ‰¹å‡†ï¼ŒåŸŸåå·²è§£å°', 'success');
          loadAppeals();
        } else {
          showAlert('appeals-alert', data.error || 'æ“ä½œå¤±è´¥', 'error');
        }
      } catch (error) {
        showAlert('appeals-alert', 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    async function rejectAppeal(id) {
      const admin_note = prompt('è¯·è¾“å…¥æ‹’ç»åŸå› :');
      if (admin_note === null) return;

      try {
        const res = await fetch('/api/admin/appeals', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, action: 'reject', admin_note })
        });

        const data = await res.json();
        if (data.success) {
          showAlert('appeals-alert', 'ç”³è¯‰å·²æ‹’ç»', 'success');
          loadAppeals();
        } else {
          showAlert('appeals-alert', data.error || 'æ“ä½œå¤±è´¥', 'error');
        }
      } catch (error) {
        showAlert('appeals-alert', 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    // ä¸¾æŠ¥ç®¡ç†é¡µé¢
    async function loadReports(status = 'pending') {
      const page = document.getElementById('reports');
      page.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      try {
        const params = new URLSearchParams({ status, limit: 100 });
        const res = await fetch(`/api/admin/reports?${params}`);
        const data = await res.json();

        if (data.success) {
          const reports = data.data.reports;
          page.innerHTML = `
            <h1 style="margin-bottom: 1.5rem;">ä¸¾æŠ¥ç®¡ç†</h1>
            <div id="reports-alert"></div>
            <div class="card">
              <div class="search-bar">
                <select id="report-status" value="${status}">
                  <option value="pending">å¾…å¤„ç†</option>
                  <option value="resolved">å·²å¤„ç†</option>
                  <option value="rejected">å·²æ‹’ç»</option>
                </select>
                <button class="btn btn-primary" onclick="filterReports()">ç­›é€‰</button>
              </div>
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>è¢«ä¸¾æŠ¥åŸŸå</th>
                      <th>ä¸¾æŠ¥äºº</th>
                      <th>ä¸¾æŠ¥åŸå› </th>
                      <th>ä¸¾æŠ¥æ—¶é—´</th>
                      <th>çŠ¶æ€</th>
                      <th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${reports.length === 0 ? '<tr><td colspan="6" class="empty-state">æ— æ•°æ®</td></tr>' : reports.map(report => `
                      <tr>
                        <td>${report.label}.py.kg</td>
                        <td>${report.reporter_username || report.reporter_linuxdo_id}</td>
                        <td style="max-width: 300px;">${report.reason}</td>
                        <td>${new Date(report.created_at).toLocaleString('zh-CN')}</td>
                        <td>
                          ${report.status === 'pending' ? '<span class="badge badge-warning">å¾…å¤„ç†</span>' : ''}
                          ${report.status === 'resolved' ? '<span class="badge badge-success">å·²å¤„ç†</span>' : ''}
                          ${report.status === 'rejected' ? '<span class="badge badge-danger">å·²æ‹’ç»</span>' : ''}
                        </td>
                        <td>
                          ${report.status === 'pending' ? `
                            <div class="action-buttons">
                              <button class="btn btn-warning btn-sm" onclick="suspendReportedDomain(${report.id})">æš‚åœè§£æ</button>
                              <button class="btn btn-danger btn-sm" onclick="deleteReportedDomain(${report.id})">åˆ é™¤åŸŸå</button>
                              <button class="btn btn-secondary btn-sm" onclick="rejectReport(${report.id})">æ‹’ç»ä¸¾æŠ¥</button>
                            </div>
                          ` : '-'}
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          `;
        }
      } catch (error) {
        page.innerHTML = '<div class="alert alert-error">åŠ è½½å¤±è´¥</div>';
      }
    }

    function filterReports() {
      const status = document.getElementById('report-status').value;
      loadReports(status);
    }

    async function suspendReportedDomain(id) {
      const reason = prompt('è¯·è¾“å…¥æš‚åœåŸå› ï¼ˆå¯é€‰ï¼‰:');
      if (reason === null) return; // ç”¨æˆ·ç‚¹å‡»å–æ¶ˆ

      try {
        const res = await fetch('/api/admin/reports', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ids: [id],
            actions: {
              suspend_domain: true,
              close_report: true
            },
            reason: reason || 'ä¸¾æŠ¥ç¡®è®¤è¿è§„'
          })
        });

        const data = await res.json();
        if (data.success) {
          showAlert('reports-alert', 'ä¸¾æŠ¥å·²å¤„ç†ï¼ŒåŸŸåå·²æš‚åœ', 'success');
          loadReports();
        } else {
          showAlert('reports-alert', data.error || 'æ“ä½œå¤±è´¥', 'error');
        }
      } catch (error) {
        showAlert('reports-alert', 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    async function deleteReportedDomain(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¢«ä¸¾æŠ¥çš„åŸŸåå—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) return;

      const reason = prompt('è¯·è¾“å…¥åˆ é™¤åŸå› ï¼ˆå¯é€‰ï¼‰:');
      if (reason === null) return; // ç”¨æˆ·ç‚¹å‡»å–æ¶ˆ

      try {
        const res = await fetch('/api/admin/reports', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ids: [id],
            actions: {
              delete_domain: true,
              close_report: true
            },
            reason: reason || 'ä¸¾æŠ¥ç¡®è®¤è¿è§„'
          })
        });

        const data = await res.json();
        if (data.success) {
          showAlert('reports-alert', 'ä¸¾æŠ¥å·²å¤„ç†ï¼ŒåŸŸåå·²åˆ é™¤', 'success');
          loadReports();
        } else {
          showAlert('reports-alert', data.error || 'æ“ä½œå¤±è´¥', 'error');
        }
      } catch (error) {
        showAlert('reports-alert', 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    async function rejectReport(id) {
      if (!confirm('ç¡®å®šè¦æ‹’ç»æ­¤ä¸¾æŠ¥å—ï¼Ÿ')) return;

      try {
        const res = await fetch('/api/admin/reports', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ids: [id],
            actions: {
              close_report: true
            }
          })
        });

        const data = await res.json();
        if (data.success) {
          showAlert('reports-alert', 'å·²æ‹’ç»ä¸¾æŠ¥', 'success');
          loadReports();
        } else {
          showAlert('reports-alert', data.error || 'æ“ä½œå¤±è´¥', 'error');
        }
      } catch (error) {
        showAlert('reports-alert', 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    // æ•æ„Ÿè¯ç®¡ç†é¡µé¢
    async function loadBannedWords() {
      const page = document.getElementById('banned-words');
      page.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      try {
        const res = await fetch('/api/admin/banned-words');
        const data = await res.json();

        if (data.success) {
          const words = data.data.words;
          page.innerHTML = `
            <h1 style="margin-bottom: 1.5rem;">æ•æ„Ÿè¯ç®¡ç†</h1>
            <div id="banned-words-alert"></div>

            <div class="card" style="background: #fff3cd; border-left: 4px solid #ffc107; margin-bottom: 1.5rem;">
              <h3 style="margin-top: 0; color: #856404;">ğŸ“‹ æ”¿ç­–è¯´æ˜</h3>
              <p style="margin-bottom: 0.5rem;"><strong>ç³»ç»Ÿä¿ç•™è¯ï¼š</strong>å‚è€ƒ <a href="https://github.com/js-org/js.org" target="_blank" style="color: #0066cc;">js.org æ”¿ç­–</a>ï¼ŒåŒ…å« 470+ ä¸ªå¸¸è§æŠ€æœ¯è¯æ±‡ï¼ˆå¦‚ apiã€adminã€www ç­‰ï¼‰ï¼Œç”±ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†ï¼Œç¡¬æ€§é˜»æ­¢æ³¨å†Œã€‚</p>
              <p style="margin-bottom: 0;"><strong>è‡ªå®šä¹‰æ•æ„Ÿè¯ï¼š</strong>ä¸‹æ–¹å¯æ·»åŠ ä¸å½“å†…å®¹ç›¸å…³è¯æ±‡ï¼ˆå¦‚è‰²æƒ…ã€èµŒåšç­‰ï¼‰ï¼Œè§¦å‘åéœ€äººå·¥å®¡æ ¸ã€‚</p>
            </div>

            <div class="card">
              <h2>æ·»åŠ è‡ªå®šä¹‰æ•æ„Ÿè¯</h2>
              <form id="add-word-form">
                <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                  <div class="form-group" style="flex: 1; margin-bottom: 0;">
                    <label>æ•æ„Ÿè¯</label>
                    <input type="text" name="word" placeholder="è¾“å…¥æ•æ„Ÿè¯" required>
                  </div>
                  <div class="form-group" style="width: 200px; margin-bottom: 0;">
                    <label>åˆ†ç±»</label>
                    <select name="category">
                      <option value="inappropriate">ä¸å½“å†…å®¹</option>
                      <option value="general">ä¸€èˆ¬</option>
                    </select>
                  </div>
                  <button type="submit" class="btn btn-primary">æ·»åŠ </button>
                </div>
              </form>
            </div>
            <div class="card">
              <h2>è‡ªå®šä¹‰æ•æ„Ÿè¯åˆ—è¡¨ (${words.length})</h2>
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>æ•æ„Ÿè¯</th>
                      <th>åˆ†ç±»</th>
                      <th>æ·»åŠ æ—¶é—´</th>
                      <th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${words.length === 0 ? '<tr><td colspan="4" class="empty-state">æ— æ•°æ®</td></tr>' : words.map(word => `
                      <tr>
                        <td>${word.word}</td>
                        <td>
                          ${word.category === 'inappropriate' ? '<span class="badge badge-danger">ä¸å½“å†…å®¹</span>' : ''}
                          ${word.category === 'general' ? '<span class="badge badge-warning">ä¸€èˆ¬</span>' : ''}
                        </td>
                        <td>${new Date(word.created_at).toLocaleString('zh-CN')}</td>
                        <td>
                          <button class="btn btn-danger btn-sm" onclick="deleteBannedWord(${word.id})">åˆ é™¤</button>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          `;

          document.getElementById('add-word-form').addEventListener('submit', addBannedWord);
        }
      } catch (error) {
        page.innerHTML = '<div class="alert alert-error">åŠ è½½å¤±è´¥</div>';
      }
    }

    async function addBannedWord(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);

      try {
        const res = await fetch('/api/admin/banned-words', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            word: formData.get('word'),
            category: formData.get('category')
          })
        });

        const data = await res.json();
        if (data.success) {
          showAlert('banned-words-alert', 'æ•æ„Ÿè¯å·²æ·»åŠ ', 'success');
          form.reset();
          loadBannedWords();
        } else {
          showAlert('banned-words-alert', data.error || 'æ·»åŠ å¤±è´¥', 'error');
        }
      } catch (error) {
        showAlert('banned-words-alert', 'æ·»åŠ å¤±è´¥', 'error');
      }
    }

    async function deleteBannedWord(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ•æ„Ÿè¯å—ï¼Ÿ')) return;

      try {
        const res = await fetch('/api/admin/banned-words', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        });

        const data = await res.json();
        if (data.success) {
          showAlert('banned-words-alert', 'æ•æ„Ÿè¯å·²åˆ é™¤', 'success');
          loadBannedWords();
        } else {
          showAlert('banned-words-alert', data.error || 'åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        showAlert('banned-words-alert', 'åˆ é™¤å¤±è´¥', 'error');
      }
    }

    // DNSè®°å½•ç®¡ç†
    async function manageDNSRecords(domainId, fqdn) {
      const modal = document.createElement('div');
      modal.id = 'dns-modal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;';

      modal.innerHTML = `
        <div style="background: white; border-radius: 8px; width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto; padding: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="margin: 0;">DNSè®°å½•ç®¡ç† - ${fqdn}</h2>
            <button onclick="closeDNSModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
          </div>
          <div id="dns-modal-alert"></div>
          <div id="dns-records-content">
            <div class="loading">åŠ è½½ä¸­...</div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Load DNS records
      try {
        const res = await fetch(`/api/admin/dns-records?domain_id=${domainId}`);
        const data = await res.json();

        if (data.success) {
          const records = data.data.records;
          const domain = data.data.domain;

          document.getElementById('dns-records-content').innerHTML = `
            <div class="card" style="margin-bottom: 1rem;">
              <p><strong>åŸŸåçŠ¶æ€:</strong> ${domain.status === 'active' ? 'æ´»è·ƒ' : domain.status === 'suspended' ? 'å·²æš‚åœ' : domain.status}</p>
              <p><strong>æ‰€æœ‰è€…ID:</strong> ${domain.owner_linuxdo_id}</p>
              <p style="margin-bottom: 0; color: #856404;">æç¤ºï¼šç®¡ç†å‘˜å¯ä»¥åœ¨æ­¤åˆ é™¤æˆ–ä¿®æ”¹è¿è§„çš„DNSè®°å½•ï¼Œç„¶åæ¢å¤åŸŸåçŠ¶æ€ã€‚</p>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>ç±»å‹</th>
                    <th>è®°å½•å</th>
                    <th>è®°å½•å€¼</th>
                    <th>TTL</th>
                    <th>Proxied</th>
                    <th>CFåŒæ­¥</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  ${records.length === 0 ? '<tr><td colspan="7" class="empty-state">æ— DNSè®°å½•</td></tr>' : records.map(record => `
                    <tr>
                      <td><span class="badge badge-info">${record.type}</span></td>
                      <td>${record.name}</td>
                      <td style="max-width: 300px; word-break: break-all;">${record.content}</td>
                      <td>${record.ttl}</td>
                      <td>${record.proxied ? 'æ˜¯' : 'å¦'}</td>
                      <td>${record.cf_synced ? 'âœ“' : 'âœ—'}</td>
                      <td>
                        <div class="action-buttons">
                          <button class="btn btn-warning btn-sm" onclick="editDNSRecord(${record.id}, '${record.content}', ${record.ttl}, ${record.proxied})">ç¼–è¾‘</button>
                          <button class="btn btn-danger btn-sm" onclick="deleteDNSRecord(${record.id}, ${domainId}, '${fqdn}')">åˆ é™¤</button>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        } else {
          document.getElementById('dns-records-content').innerHTML = `<div class="alert alert-error">${data.error || 'åŠ è½½å¤±è´¥'}</div>`;
        }
      } catch (error) {
        document.getElementById('dns-records-content').innerHTML = '<div class="alert alert-error">åŠ è½½å¤±è´¥</div>';
      }
    }

    function closeDNSModal() {
      const modal = document.getElementById('dns-modal');
      if (modal) {
        modal.remove();
      }
    }

    async function editDNSRecord(id, currentContent, currentTtl, currentProxied) {
      const newContent = prompt('è¯·è¾“å…¥æ–°çš„è®°å½•å€¼:', currentContent);
      if (newContent === null || newContent === currentContent) return;

      const reason = prompt('è¯·è¾“å…¥ä¿®æ”¹åŸå› ï¼ˆå¯é€‰ï¼‰:');

      try {
        const res = await fetch('/api/admin/dns-records', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id,
            content: newContent,
            ttl: currentTtl,
            proxied: currentProxied === 1,
            reason
          })
        });

        const data = await res.json();
        if (data.success) {
          showAlert('dns-modal-alert', 'DNSè®°å½•å·²æ›´æ–°', 'success');
          // Reload the modal content
          const modal = document.getElementById('dns-modal');
          const fqdn = modal.querySelector('h2').textContent.split(' - ')[1];
          const domainIdMatch = modal.querySelector('[onclick*="deleteDNSRecord"]');
          if (domainIdMatch) {
            const domainId = domainIdMatch.getAttribute('onclick').match(/deleteDNSRecord\(\d+,\s*(\d+)/)[1];
            setTimeout(() => {
              closeDNSModal();
              manageDNSRecords(parseInt(domainId), fqdn);
            }, 1000);
          }
        } else {
          showAlert('dns-modal-alert', data.error || 'æ›´æ–°å¤±è´¥', 'error');
        }
      } catch (error) {
        showAlert('dns-modal-alert', 'æ›´æ–°å¤±è´¥', 'error');
      }
    }

    async function deleteDNSRecord(id, domainId, fqdn) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤DNSè®°å½•å—ï¼Ÿ')) return;

      const reason = prompt('è¯·è¾“å…¥åˆ é™¤åŸå› ï¼ˆå¯é€‰ï¼‰:');

      try {
        const res = await fetch('/api/admin/dns-records', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, reason })
        });

        const data = await res.json();
        if (data.success) {
          showAlert('dns-modal-alert', 'DNSè®°å½•å·²åˆ é™¤', 'success');
          // Reload the modal content
          setTimeout(() => {
            closeDNSModal();
            manageDNSRecords(domainId, fqdn);
          }, 1000);
        } else {
          showAlert('dns-modal-alert', data.error || 'åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        showAlert('dns-modal-alert', 'åˆ é™¤å¤±è´¥', 'error');
      }
    }

    // å·¥å…·å‡½æ•°
    function showAlert(elementId, message, type) {
      const element = document.getElementById(elementId);
      if (element) {
        element.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        setTimeout(() => element.innerHTML = '', 3000);
      }
    }

    // åˆå§‹åŒ–
    init();
  </script>
</body>
</html>
